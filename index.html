<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q√ºestionari d'Hist√≤ria - 2n d'ESO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --font-size-base: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 20px;
            --line-height: 1.5;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: var(--font-size-base);
            line-height: var(--line-height);
            color: var(--dark-color);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            position: relative;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-color);
        }
        
        h1 {
            color: var(--primary-color);
            font-size: var(--font-size-xl);
            text-align: center;
            margin-bottom: 10px;
        }
        
        h2 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .welcome-container {
            text-align: center;
            padding: 30px 0;
        }
        
        .welcome-container p {
            margin-bottom: 20px;
            font-size: var(--font-size-lg);
            line-height: 1.6;
        }
        
        .situations-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
        }
        
        .situation-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 25px 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            background: white;
            position: relative;
            overflow: hidden;
        }
        
        .situation-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-color);
        }
        
        .situation-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .situation-card i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .situation-card h3 {
            margin-bottom: 10px;
            color: var(--secondary-color);
        }
        
        .progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .progress-bar {
            width: 200px;
            height: 12px;
            background-color: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            width: 25%;
            transition: width 0.5s ease;
        }
        
        .question-info {
            background-color: var(--light-color);
            padding: 12px 18px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            border-left: 4px solid var(--primary-color);
        }
        
        .question-text {
            font-size: var(--font-size-lg);
            margin-bottom: 25px;
            font-weight: 600;
            line-height: 1.6;
        }
        
        /* Estils per a preguntes d'opci√≥ m√∫ltiple */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .option {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
        }
        
        .option:hover {
            border-color: var(--primary-color);
            background-color: #f0f7ff;
        }
        
        .option.selected {
            border-color: var(--primary-color);
            background-color: #e6f2ff;
        }
        
        .option.correct {
            border-color: var(--success-color);
            background-color: #e8f5e8;
        }
        
        .option.incorrect {
            border-color: var(--danger-color);
            background-color: #fde8e8;
        }
        
        .option input {
            margin-right: 12px;
            margin-top: 3px;
            transform: scale(1.2);
        }
        
        .option-label {
            font-weight: 500;
        }
        
        /* Estils per a preguntes vertader/fals */
        .true-false-container {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .true-false-option {
            flex: 1;
            text-align: center;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            background-color: white;
            font-size: 1.1rem;
        }
        
        .true-false-option:hover {
            border-color: var(--primary-color);
            background-color: #f0f7ff;
        }
        
        .true-false-option.selected.true {
            border-color: var(--success-color);
            background-color: #e8f5e8;
        }
        
        .true-false-option.selected.false {
            border-color: var(--danger-color);
            background-color: #fde8e8;
        }
        
        .true-false-option.correct {
            border-color: var(--success-color);
            background-color: #e8f5e8;
        }
        
        .true-false-option.incorrect {
            border-color: var(--danger-color);
            background-color: #fde8e8;
        }
        
        /* Estils per a preguntes de desenvolupament */
        .development-question {
            margin-bottom: 25px;
        }
        
        .development-textarea {
            width: 100%;
            min-height: 180px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            font-size: var(--font-size-base);
            line-height: var(--line-height);
            resize: vertical;
            transition: border-color 0.2s;
        }
        
        .development-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }
        
        /* Estils per a preguntes d'emplenar buits */
        .fill-blanks-container {
            margin-bottom: 25px;
        }
        
        .fill-text {
            font-size: var(--font-size-base);
            line-height: 1.8;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .blank-input {
            display: inline-block;
            width: 150px;
            padding: 8px 12px;
            border: 1px dashed #aaa;
            border-radius: 4px;
            background-color: #fff;
            margin: 0 5px;
            text-align: center;
        }
        
        .blank-input.correct {
            border: 2px solid var(--success-color);
            background-color: #e8f5e8;
        }
        
        .blank-input.incorrect {
            border: 2px solid var(--danger-color);
            background-color: #fde8e8;
        }
        
        /* Botons */
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .submit-btn {
            background-color: var(--primary-color);
            color: white;
        }
        
        .submit-btn:hover {
            background-color: var(--secondary-color);
        }
        
        .next-btn {
            background-color: var(--success-color);
            color: white;
        }
        
        .next-btn:hover {
            background-color: #218838;
        }
        
        .prev-btn {
            background-color: #6c757d;
            color: white;
        }
        
        .prev-btn:hover {
            background-color: #5a6268;
        }
        
        .home-btn {
            background-color: #6c757d;
            color: white;
        }
        
        .home-btn:hover {
            background-color: #5a6268;
        }
        
        /* Sistema de qualificaci√≥ */
        .grading-system {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
        }
        
        .grade-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--secondary-color);
        }
        
        .grade-levels {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .grade-level {
            text-align: center;
            flex: 1;
            padding: 5px;
            font-weight: 500;
        }
        
        .grade-level.insufficient {
            color: var(--danger-color);
        }
        
        .grade-level.sufficient {
            color: #fd7e14;
        }
        
        .grade-level.good {
            color: var(--warning-color);
        }
        
        .grade-level.notable {
            color: #20c997;
        }
        
        .grade-level.excellent {
            color: var(--success-color);
        }
        
        /* Feedback Millorat - Simulant IA */
        .feedback-container {
            margin-top: 20px;
            padding: 25px;
            border-radius: 10px;
            background: linear-gradient(135deg, #e8f4f8 0%, #d4edda 100%);
            border-left: 6px solid var(--primary-color);
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .feedback-title {
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }
        
        .feedback-content {
            line-height: 1.7;
        }
        
        .multidimensional-rating {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .rating-dimension {
            text-align: center;
            padding: 10px;
        }
        
        .dimension-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: var(--dark-color);
        }
        
        .dimension-score {
            font-size: 1.2rem;
            font-weight: 700;
        }
        
        .dimension-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }
        
        .dimension-progress {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }
        
        .strengths-list, .improvements-list, .suggestions-list {
            margin: 15px 0;
            padding-left: 20px;
        }
        
        .strengths-list li, .improvements-list li, .suggestions-list li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .strengths-list li::marker {
            color: var(--success-color);
            content: '‚úì ';
        }
        
        .improvements-list li::marker {
            color: var(--warning-color);
            content: '‚Üª ';
        }
        
        .suggestions-list li::marker {
            color: var(--primary-color);
            content: 'üí° ';
        }
        
        .comparison-analysis {
            background: #f0f8ff;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #4a6fa5;
        }
        
        .motivational-message {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-style: italic;
            border: 1px dashed #ffc107;
        }
        
        .badge-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .badge {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #4a6fa5, #166088);
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .badge.locked {
            background: linear-gradient(135deg, #ccc, #999);
            opacity: 0.6;
        }
        
        .badge.unlocked {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        
        .grade-indicator {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 700;
            margin-bottom: 15px;
            font-size: 1.1rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .grade-indicator.insufficient {
            background-color: #f8d7da;
            color: var(--danger-color);
        }
        
        .grade-indicator.sufficient {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .grade-indicator.good {
            background-color: #e2f0fb;
            color: #0c5460;
        }
        
        .grade-indicator.notable {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .grade-indicator.excellent {
            background-color: #d4edda;
            color: var(--success-color);
        }
        
        .model-answer {
            margin-top: 20px;
            padding: 20px;
            background-color: #f0f8ff;
            border-radius: 10px;
            border-left: 6px solid #4a6fa5;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .model-answer-title {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }
        
        .toggle-model-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 600;
            padding: 8px 0;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1rem;
        }
        
        .toggle-model-btn:hover {
            color: var(--secondary-color);
        }
        
        /* Millores d'accessibilitat */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .accessibility-options {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .accessibility-btn {
            background: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .high-contrast {
            color: #000;
            background-color: #fff;
        }
        
        .large-text {
            font-size: 20px;
        }
        
        /* Pantalles */
        .screen {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        /* Responsivitat */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .true-false-container {
                flex-direction: column;
            }
            
            .multidimensional-rating {
                grid-template-columns: 1fr;
            }
            
            .grade-levels {
                flex-direction: column;
                gap: 5px;
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .progress-container {
                width: 100%;
            }
            
            .progress-bar {
                flex-grow: 1;
            }
            
            .situations-container {
                grid-template-columns: 1fr;
            }
            
            .button-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .button-container button {
                width: 100%;
                justify-content: center;
            }
            
            .badge-container {
                flex-wrap: wrap;
            }
        }
        
        .result-correct {
            color: var(--success-color);
            font-weight: bold;
            margin-top: 10px;
            font-size: 1.1rem;
        }
        
        .result-incorrect {
            color: var(--danger-color);
            font-weight: bold;
            margin-top: 10px;
            font-size: 1.1rem;
        }
        
        .loading-indicator {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: var(--secondary-color);
        }
        
        .ai-thinking {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 15px;
            background: #f0f8ff;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .ai-thinking i {
            color: var(--primary-color);
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="accessibility-options">
            <button class="accessibility-btn" id="contrast-btn">
                <i class="fas fa-adjust"></i> Alt contrast
            </button>
            <button class="accessibility-btn" id="text-size-btn">
                <i class="fas fa-text-height"></i> Text gran
            </button>
        </div>
        
        <!-- Pantalla de benvinguda -->
        <div class="screen active" id="welcome-screen">
            <div class="welcome-container">
                <h1>Q√ºestionari d'Hist√≤ria - 2n d'ESO</h1>
                <p>Benvingut/da al q√ºestionari d'Hist√≤ria de 2n d'ESO. Aqu√≠ podr√†s repassar els continguts de les quatre situacions d'aprenentatge del curs.</p>
                <p>Selecciona una de les situacions d'aprenentatge per comen√ßar:</p>
                
                <div class="situations-container">
                    <div class="situation-card" data-situation="0">
                        <i class="fas fa-landmark"></i>
                        <h3>Caiguda de l'Imperi Rom√†</h3>
                        <p>Analitza les causes i conseq√º√®ncies de la caiguda de l'Imperi Rom√† d'Occident</p>
                    </div>
                    <div class="situation-card" data-situation="1">
                        <i class="fas fa-chess-rook"></i>
                        <h3>Imperi Bizant√≠</h3>
                        <p>Descobreix l'Imperi Rom√† d'Orient i la seva import√†ncia hist√≤rica</p>
                    </div>
                    <div class="situation-card" data-situation="2">
                        <i class="fas fa-mosque"></i>
                        <h3>Imperi Isl√†mic</h3>
                        <p>Explora l'expansi√≥ i l'her√®ncia de l'Imperi Isl√†mic</p>
                    </div>
                    <div class="situation-card" data-situation="3">
                        <i class="fas fa-crown"></i>
                        <h3>Imperi Carolingi</h3>
                        <p>Con√®ixer l'Imperi de Carlemany i el seu llegat</p>
                    </div>
                </div>
                
                <div class="badge-container">
                    <div class="badge locked" title="Expert en Roma - Bloquejada">
                        <i class="fas fa-landmark"></i>
                    </div>
                    <div class="badge locked" title="Coneixedor Bizant√≠ - Bloquejada">
                        <i class="fas fa-chess-rook"></i>
                    </div>
                    <div class="badge locked" title="Erudit Isl√†mic - Bloquejada">
                        <i class="fas fa-mosque"></i>
                    </div>
                    <div class="badge locked" title="Mestre Carolingi - Bloquejada">
                        <i class="fas fa-crown"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pantalla de pregunta -->
        <div class="screen" id="question-screen">
            <header>
                <button class="home-btn" id="home-btn">
                    <i class="fas fa-home"></i> Torna a l'inici
                </button>
                <div class="progress-container">
                    <span>Progr√©s:</span>
                    <div class="progress-bar">
                        <div class="progress" id="progress-bar"></div>
                    </div>
                    <span id="progress-text">1/4</span>
                </div>
            </header>
            
            <div class="question-info" id="question-info">Caiguda de l'Imperi Rom√† - 1/4</div>
            
            <div class="question-text" id="question-text">
                <!-- El text de la pregunta es carregar√† din√†micament -->
            </div>
            
            <div id="question-content">
                <!-- El contingut de la pregunta (opcions, textarea, etc.) es carregar√† din√†micament -->
            </div>
            
            <div class="grading-system">
                <div class="grade-title">Sistema de qualificaci√≥ per a respostes de desenvolupament:</div>
                <div class="grade-levels">
                    <div class="grade-level insufficient">A millorar</div>
                    <div class="grade-level sufficient">Suficient</div>
                    <div class="grade-level good">B√©</div>
                    <div class="grade-level notable">Notable</div>
                    <div class="grade-level excellent">Excel¬∑lent</div>
                </div>
                <div>
                    Recorda que valorarem el teu esfor√ß i la teva capacitat d'explicar les teves idees.
                </div>
            </div>
            
            <button class="toggle-model-btn" id="toggle-model-btn">
                <i class="fas fa-eye"></i> Mostra model de resposta
            </button>
            
            <div class="model-answer" id="model-answer">
                <div class="model-answer-title">
                    <i class="fas fa-lightbulb"></i> Model de resposta
                </div>
                <div id="model-answer-content">
                    <!-- El contingut del model es carregar√† din√†micament -->
                </div>
            </div>
            
            <div class="feedback-container" id="feedback-container">
                <div class="feedback-title">
                    <i class="fas fa-robot"></i> An√†lisi de la teva resposta
                </div>
                <div class="grade-indicator good" id="grade-indicator">Qualificaci√≥: B√©</div>
                
                <div class="multidimensional-rating" id="multidimensional-rating">
                    <!-- Les dimensions d'avaluaci√≥ es carregaran din√†micament -->
                </div>
                
                <div class="feedback-content" id="feedback-content">
                    <!-- El contingut del feedback es carregar√† din√†micament -->
                </div>
                
                <div class="comparison-analysis" id="comparison-analysis">
                    <!-- L'an√†lisi comparatiu es carregar√† din√†micament -->
                </div>
                
                <div class="motivational-message" id="motivational-message">
                    <!-- El missatge motivacional es carregar√† din√†micament -->
                </div>
            </div>
            
            <div class="button-container">
                <button class="prev-btn" id="prev-btn">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button class="submit-btn" id="submit-btn">
                    <i class="fas fa-paper-plane"></i> Envia la resposta
                </button>
                <button class="next-btn" id="next-btn">
                    Seg√ºent <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Dades del q√ºestionari
        const questions = [
            // SA1: Caiguda de l'Imperi Rom√†
            {
                id: "SA1",
                title: "Caiguda de l'Imperi Rom√†",
                type: "multiple-choice",
                text: "Quin dels seg√ºents factors va ser una causa pol√≠tica de la crisi de l'Imperi Rom√† d'Occident?",
                options: [
                    "La p√®rdua de terres cultivables per l'erosi√≥.",
                    "La inestabilitat i les guerres civils per la successi√≥ imperial.",
                    "La importaci√≥ massiva de seda de la Xina.",
                    "L'aparici√≥ de noves tecnologies militars."
                ],
                correctAnswer: 1,
                modelAnswer: "La resposta correcta √©s: <strong>La inestabilitat i les guerres civils per la successi√≥ imperial</strong>. Aquest factor √©s una causa pol√≠tica perqu√® afecta directament la manera com es governa l'imperi. Les lluites per el poder entre diferents faccions i la manca d'un sistema clar de successi√≥ feien que l'imperi estigu√©s constantment debilitat per conflictes interns. Aix√≤ afeblia la capacitat de l'imperi per respondre a amenaces externes i gestionar eficientment els seus territoris.",
                badge: {
                    name: "üèõÔ∏è Expert en Roma",
                    icon: "fas fa-landmark"
                }
            },
            // SA2: Imperi Bizant√≠
            {
                id: "SA2",
                title: "Imperi Bizant√≠",
                type: "true-false",
                text: "L'Imperi Bizant√≠ va ser la continuaci√≥ de l'Imperi Rom√† d'Orient despr√©s de la caiguda de l'Imperi Rom√† d'Occident.",
                correctAnswer: true,
                modelAnswer: "La resposta correcta √©s: <strong>Vertader</strong>. L'Imperi Bizant√≠ va ser la continuaci√≥ de l'Imperi Rom√† d'Orient, amb capital a Constantinoble, i va perviure durant gaireb√© mil anys despr√©s de la caiguda de l'Imperi Rom√† d'Occident. Va mantenir molts elements de la cultura romana, com el dret rom√† i l'administraci√≥, per√≤ amb fortes influ√®ncies gregues i cristianes orientals.",
                badge: {
                    name: "üëë Coneixedor Bizant√≠",
                    icon: "fas fa-chess-rook"
                }
            },
            // SA3: Imperi Isl√†mic
            {
                id: "SA3",
                title: "Imperi Isl√†mic",
                type: "development",
                text: "Explica com es va expandir l'Imperi Isl√†mic durant els primers segles despr√©s de la H√®gira.",
                modelAnswer: "L'Imperi Isl√†mic es va expandir r√†pidament despr√©s de la H√®gira (622 dC). En poc m√©s d'un segle, els musulmans van conquerir un vast territori que s'estenia des de la Pen√≠nsula Ib√®rica fins a l'√çndia. Aquesta expansi√≥ es va deure a diversos factors:<br><br>1. <strong>Unificaci√≥ religiosa</strong>: L'islam va unificar les tribus √†rabs.<br>2. <strong>Debilitat dels imperis ve√Øns</strong>: L'Imperi Bizant√≠ i l'Imperi Sass√†nida estaven afeblits per guerres entre ells.<br>3. <strong>Toler√†ncia religiosa</strong>: Els musulmans eren tolerants amb les 'gentes del llibre' (cristians i jueus).<br>4. <strong>Incentius econ√≤mics</strong>: Les conquestes oferien bot√≠ i noves terres.<br><br>Aquests factors econ√≤mics van afeblir l'estat i van reduir la seva capacitat per defensar-se.",
                badge: {
                    name: "üìú Erudit Isl√†mic",
                    icon: "fas fa-mosque"
                }
            },
            // SA4: Imperi Carolingi
            {
                id: "SA4",
                title: "Imperi Carolingi",
                type: "fill-blanks",
                text: "Completa els buits en el seg√ºent text sobre l'Imperi Carolingi:",
                fillText: "L'Imperi Carolingi va ser fundat per <input type='text' class='blank-input' id='blank1'> al segle <input type='text' class='blank-input' id='blank2'>. El seu regnat va assolir el punt √†lgid amb la coronaci√≥ com a emperador per part del papa <input type='text' class='blank-input' id='blank3'> l'any <input type='text' class='blank-input' id='blank4'>. L'imperi es va dividir despr√©s de la seva mort amb el <input type='text' class='blank-input' id='blank5'> de Verdun l'any 843.",
                blanks: [
                    { id: "blank1", answer: "Carlemany" },
                    { id: "blank2", answer: "VIII" },
                    { id: "blank3", answer: "Lle√≥ III" },
                    { id: "blank4", answer: "800" },
                    { id: "blank5", answer: "Tractat" }
                ],
                modelAnswer: "Les respostes correctes s√≥n:<br><br>1. <strong>Carlemany</strong><br>2. <strong>VIII</strong> (vuit)<br>3. <strong>Lle√≥ III</strong><br>4. <strong>800</strong><br>5. <strong>Tractat</strong><br><br>L'Imperi Carolingi, amb Carlemany al capdavant, va representar un intent de reviure l'Imperi Rom√† d'Occident i va ser un per√≠ode de renaixement cultural conegut com el 'Renaixement Carolingi'. La divisi√≥ de l'imperi despr√©s de la seva mort va marcar l'inici de les futures nacions d'Europa occidental.",
                badge: {
                    name: "‚öîÔ∏è Mestre Carolingi",
                    icon: "fas fa-crown"
                }
            }
        ];

        // Variables d'estat
        let currentQuestionIndex = 0;
        let userAnswers = Array(questions.length).fill(null);
        let answerSubmitted = Array(questions.length).fill(false);
        let unlockedBadges = Array(questions.length).fill(false);
        
        // Elements del DOM
        const welcomeScreen = document.getElementById('welcome-screen');
        const questionScreen = document.getElementById('question-screen');
        const questionInfoEl = document.getElementById('question-info');
        const questionTextEl = document.getElementById('question-text');
        const questionContentEl = document.getElementById('question-content');
        const progressBarEl = document.getElementById('progress-bar');
        const progressTextEl = document.getElementById('progress-text');
        const submitBtn = document.getElementById('submit-btn');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const homeBtn = document.getElementById('home-btn');
        const feedbackContainerEl = document.getElementById('feedback-container');
        const feedbackContentEl = document.getElementById('feedback-content');
        const gradeIndicatorEl = document.getElementById('grade-indicator');
        const modelAnswerEl = document.getElementById('model-answer');
        const modelAnswerContentEl = document.getElementById('model-answer-content');
        const toggleModelBtn = document.getElementById('toggle-model-btn');
        const contrastBtn = document.getElementById('contrast-btn');
        const textSizeBtn = document.getElementById('text-size-btn');
        const situationCards = document.querySelectorAll('.situation-card');
        const multidimensionalRatingEl = document.getElementById('multidimensional-rating');
        const comparisonAnalysisEl = document.getElementById('comparison-analysis');
        const motivationalMessageEl = document.getElementById('motivational-message');
        const badgeElements = document.querySelectorAll('.badge');
        
        // Inicialitzaci√≥
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateBadges();
        });
        
        function showScreen(screen) {
            // Amagar totes les pantalles
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('active');
            });
            
            // Mostrar la pantalla sol¬∑licitada
            screen.classList.add('active');
        }
        
        function loadQuestion(index) {
            const question = questions[index];
            
            // Actualitzar informaci√≥ de la pregunta
            questionInfoEl.textContent = `${question.title} - ${index + 1}/${questions.length}`;
            questionTextEl.textContent = question.text;
            
            // Actualitzar barra de progr√©s
            const progressPercentage = ((index + 1) / questions.length) * 100;
            progressBarEl.style.width = `${progressPercentage}%`;
            progressTextEl.textContent = `${index + 1}/${questions.length}`;
            
            // Configurar el contingut segons el tipus de pregunta
            questionContentEl.innerHTML = '';
            
            if (question.type === 'multiple-choice') {
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'options-container';
                
                question.options.forEach((option, i) => {
                    const optionEl = document.createElement('div');
                    let optionClass = 'option';
                    
                    if (answerSubmitted[index]) {
                        if (i === question.correctAnswer) {
                            optionClass += ' correct';
                        } else if (userAnswers[index] === i) {
                            optionClass += ' incorrect';
                        }
                    } else if (userAnswers[index] === i) {
                        optionClass += ' selected';
                    }
                    
                    optionEl.className = optionClass;
                    optionEl.innerHTML = `
                        <input type="radio" id="option${i+1}" name="question" value="${i}" 
                            ${userAnswers[index] === i ? 'checked' : ''} 
                            ${answerSubmitted[index] ? 'disabled' : ''}>
                        <label for="option${i+1}" class="option-label">${option}</label>
                    `;
                    optionsContainer.appendChild(optionEl);
                });
                
                questionContentEl.appendChild(optionsContainer);
                
                // Mostrar resultat si ja s'ha enviat
                if (answerSubmitted[index]) {
                    const resultEl = document.createElement('div');
                    const isCorrect = userAnswers[index] === question.correctAnswer;
                    resultEl.className = isCorrect ? 'result-correct' : 'result-incorrect';
                    resultEl.innerHTML = isCorrect ? 
                        '<i class="fas fa-check-circle"></i> Resposta correcta!' : 
                        '<i class="fas fa-times-circle"></i> Resposta incorrecta';
                    questionContentEl.appendChild(resultEl);
                }
                
            } else if (question.type === 'true-false') {
                const trueFalseContainer = document.createElement('div');
                trueFalseContainer.className = 'true-false-container';
                
                let trueClass = 'true-false-option true';
                let falseClass = 'true-false-option false';
                
                if (answerSubmitted[index]) {
                    if (question.correctAnswer === true) {
                        trueClass += ' correct';
                        falseClass += ' incorrect';
                    } else {
                        trueClass += ' incorrect';
                        falseClass += ' correct';
                    }
                } else {
                    if (userAnswers[index] === true) trueClass += ' selected';
                    if (userAnswers[index] === false) falseClass += ' selected';
                }
                
                trueFalseContainer.innerHTML = `
                    <div class="${trueClass}" data-value="true" ${answerSubmitted[index] ? 'style="pointer-events:none;"' : ''}>
                        Vertader
                    </div>
                    <div class="${falseClass}" data-value="false" ${answerSubmitted[index] ? 'style="pointer-events:none;"' : ''}>
                        Fals
                    </div>
                `;
                
                questionContentEl.appendChild(trueFalseContainer);
                
                // Mostrar resultat si ja s'ha enviat
                if (answerSubmitted[index]) {
                    const resultEl = document.createElement('div');
                    const isCorrect = userAnswers[index] === question.correctAnswer;
                    resultEl.className = isCorrect ? 'result-correct' : 'result-incorrect';
                    resultEl.innerHTML = isCorrect ? 
                        '<i class="fas fa-check-circle"></i> Resposta correcta!' : 
                        '<i class="fas fa-times-circle"></i> Resposta incorrecta';
                    questionContentEl.appendChild(resultEl);
                }
                
            } else if (question.type === 'development') {
                const developmentContainer = document.createElement('div');
                developmentContainer.className = 'development-question';
                
                developmentContainer.innerHTML = `
                    <textarea class="development-textarea" placeholder="Escriu la teva resposta aqu√≠..." 
                        ${answerSubmitted[index] ? 'disabled' : ''}>${userAnswers[index] || ''}</textarea>
                `;
                
                questionContentEl.appendChild(developmentContainer);
                
            } else if (question.type === 'fill-blanks') {
                const fillContainer = document.createElement('div');
                fillContainer.className = 'fill-blanks-container';
                
                let fillHTML = `<div class="fill-text">${question.fillText}</div>`;
                
                fillContainer.innerHTML = fillHTML;
                questionContentEl.appendChild(fillContainer);
                
                // Configurar els inputs dels buits
                question.blanks.forEach(blank => {
                    const input = document.getElementById(blank.id);
                    if (input) {
                        if (userAnswers[index] && userAnswers[index][blank.id]) {
                            input.value = userAnswers[index][blank.id];
                        }
                        
                        if (answerSubmitted[index]) {
                            input.disabled = true;
                            if (input.value.toLowerCase() === blank.answer.toLowerCase()) {
                                input.classList.add('correct');
                            } else {
                                input.classList.add('incorrect');
                            }
                        }
                        
                        input.addEventListener('input', function() {
                            if (!userAnswers[index]) {
                                userAnswers[index] = {};
                            }
                            userAnswers[index][blank.id] = this.value;
                        });
                    }
                });
                
                // Mostrar resultat si ja s'ha enviat
                if (answerSubmitted[index]) {
                    const resultEl = document.createElement('div');
                    let correctCount = 0;
                    question.blanks.forEach(blank => {
                        const input = document.getElementById(blank.id);
                        if (input && input.value.toLowerCase() === blank.answer.toLowerCase()) {
                            correctCount++;
                        }
                    });
                    
                    const percentage = (correctCount / question.blanks.length) * 100;
                    resultEl.className = percentage >= 60 ? 'result-correct' : 'result-incorrect';
                    resultEl.innerHTML = percentage >= 60 ? 
                        `<i class="fas fa-check-circle"></i> Has encertat ${correctCount} de ${question.blanks.length} buits (${percentage}%)` :
                        `<i class="fas fa-times-circle"></i> Has encertat ${correctCount} de ${question.blanks.length} buits (${percentage}%)`;
                    questionContentEl.appendChild(resultEl);
                }
            }
            
            // Actualitzar model de resposta
            modelAnswerContentEl.innerHTML = question.modelAnswer;
            
            // Amagar feedback i model de resposta per defecte
            feedbackContainerEl.style.display = 'none';
            modelAnswerEl.style.display = 'none';
            toggleModelBtn.innerHTML = '<i class="fas fa-eye"></i> Mostra model de resposta';
            
            // Actualitzar visibilitat dels botons
            prevBtn.style.display = index === 0 ? 'none' : 'flex';
            nextBtn.style.display = index === questions.length - 1 ? 'none' : 'flex';
            submitBtn.style.display = answerSubmitted[index] ? 'none' : 'flex';
            
            // Configurar events per a les opcions (si no s'ha enviat)
            if (!answerSubmitted[index]) {
                setupQuestionEvents(question.type);
            }
        }
        
        function setupQuestionEvents(type) {
            if (type === 'multiple-choice') {
                const options = document.querySelectorAll('.option');
                options.forEach(option => {
                    option.addEventListener('click', function() {
                        if (answerSubmitted[currentQuestionIndex]) return;
                        
                        const radioInput = this.querySelector('input[type="radio"]');
                        radioInput.checked = true;
                        
                        options.forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');
                        
                        userAnswers[currentQuestionIndex] = parseInt(radioInput.value);
                    });
                });
            } else if (type === 'true-false') {
                const trueFalseOptions = document.querySelectorAll('.true-false-option');
                trueFalseOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        if (answerSubmitted[currentQuestionIndex]) return;
                        
                        const value = this.getAttribute('data-value') === 'true';
                        
                        trueFalseOptions.forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        
                        this.classList.add('selected');
                        userAnswers[currentQuestionIndex] = value;
                    });
                });
            } else if (type === 'development') {
                const textarea = document.querySelector('.development-textarea');
                textarea.addEventListener('input', function() {
                    userAnswers[currentQuestionIndex] = this.value;
                });
            }
            // Per a 'fill-blanks', els events ja s'han configurat a loadQuestion
        }
        
        // Simulador d'IA per a feedback avan√ßat
        const aiFeedbackSimulator = {
            analyzeAnswer: function(answer, question, userAnswer) {
                // An√†lisi multidimensional
                const dimensions = this.analyzeDimensions(answer, question);
                
                // Detecci√≥ d'elements positius
                const strengths = this.detectStrengths(answer, question);
                
                // √Ärees de millora
                const improvements = this.detectImprovements(answer, question);
                
                // Suggeriments espec√≠fics
                const suggestions = this.generateSuggestions(answer, question);
                
                // An√†lisi comparativa amb el model
                const comparison = this.compareWithModel(answer, question);
                
                // Missatge motivacional
                const motivation = this.generateMotivation(dimensions.totalScore);
                
                return {
                    dimensions,
                    strengths,
                    improvements,
                    suggestions,
                    comparison,
                    motivation,
                    grade: this.calculateGrade(dimensions.totalScore)
                };
            },
            
            analyzeDimensions: function(answer, question) {
                const answerLower = answer.toLowerCase();
                let contentScore = 0;
                let structureScore = 0;
                let vocabularyScore = 0;
                let depthScore = 0;
                let creativityScore = 0;
                
                // An√†lisi de contingut (paraules clau)
                const keywords = this.getKeywordsForQuestion(question.id);
                let matchedKeywords = 0;
                
                keywords.forEach(keyword => {
                    if (answerLower.includes(keyword)) {
                        matchedKeywords++;
                    }
                });
                
                contentScore = Math.min(5, (matchedKeywords / keywords.length) * 5);
                
                // An√†lisi d'estructura
                const wordCount = answer.split(/\s+/).length;
                const sentenceCount = answer.split(/[.!?]+/).length - 1;
                const hasParagraphs = answer.split('\n\n').length > 1;
                const hasConnectors = /(a m√©s|tamb√©|perqu√®|a causa de|per tant|no obstant|per exemple|per aix√≤)/i.test(answer);
                
                if (wordCount > 150) structureScore += 2;
                if (sentenceCount > 5) structureScore += 1;
                if (hasParagraphs) structureScore += 1;
                if (hasConnectors) structureScore += 1;
                
                // An√†lisi de vocabulari
                const specificTerms = this.getSpecificTerms(question.id);
                let matchedTerms = 0;
                
                specificTerms.forEach(term => {
                    if (answerLower.includes(term)) {
                        matchedTerms++;
                    }
                });
                
                vocabularyScore = Math.min(5, (matchedTerms / specificTerms.length) * 5);
                
                // An√†lisi de profunditat
                const hasCausal = /(va provocar|com a resultat|a conseq√º√®ncia|degut a|perqu√®)/i.test(answer);
                const hasComparative = /(a difer√®ncia de|en canvi|per contra|similar a)/i.test(answer);
                const hasTemporal = /(primer|despr√©s|finalment|mentrestant|alhora)/i.test(answer);
                
                if (hasCausal) depthScore += 2;
                if (hasComparative) depthScore += 1.5;
                if (hasTemporal) depthScore += 1.5;
                
                // An√†lisi de creativitat
                const hasExamples = /(per exemple|com ara|per il¬∑lustrar|com va passar)/i.test(answer);
                const hasPersonalReflection = /(crec que|opino que|considero|des del meu punt de vista)/i.test(answer);
                const hasQuestions = /\?/.test(answer);
                
                if (hasExamples) creativityScore += 2;
                if (hasPersonalReflection) creativityScore += 2;
                if (hasQuestions) creativityScore += 1;
                
                const totalScore = (contentScore + structureScore + vocabularyScore + depthScore + creativityScore) / 5;
                
                return {
                    content: Math.round(contentScore * 10) / 10,
                    structure: Math.round(structureScore * 10) / 10,
                    vocabulary: Math.round(vocabularyScore * 10) / 10,
                    depth: Math.round(depthScore * 10) / 10,
                    creativity: Math.round(creativityScore * 10) / 10,
                    totalScore: Math.round(totalScore * 10) / 10
                };
            },
            
            getKeywordsForQuestion: function(questionId) {
                const keywordMap = {
                    'SA1': ['inestabilitat', 'guerres civils', 'successi√≥ imperial', 'pol√≠tica', 'corrupci√≥', 'administraci√≥', 'imperi', 'rom√†'],
                    'SA2': ['bizant√≠', 'constantinoble', 'orient', 'continuaci√≥', 'rom√†', 'imperi', 'cristi√†', 'cultura'],
                    'SA3': ['expansi√≥', 'isl√†mic', 'h√®gira', 'mahoma', 'tribus √†rabs', 'conquesta', 'islam', 'califat', 'bizant√≠', 'sass√†nida'],
                    'SA4': ['carlemany', 'carolingi', 'coronaci√≥', 'lle√≥ iii', 'tractat de verdun', 'imperi', 'divisi√≥', 'renaixement']
                };
                
                return keywordMap[questionId] || [];
            },
            
            getSpecificTerms: function(questionId) {
                const termMap = {
                    'SA1': ['p√®rdua de terres', 'erosi√≥', 'importaci√≥', 'seda', 'tecnologies militars', 'successi√≥', 'guerres civils'],
                    'SA2': ['imperi rom√† dorient', 'constantinoble', 'bizanci', 'continu√Øtat', 'caiguda occident'],
                    'SA3': ['h√®gira', 'mahoma', 'expansi√≥', 'tribus √†rabs', 'islam', 'conquesta', 'califat'],
                    'SA4': ['carlemany', 'carolingi', 'coronaci√≥', 'papa', 'tractat de verdun', 'divisi√≥', 'renaixement']
                };
                
                return termMap[questionId] || [];
            },
            
            detectStrengths: function(answer, question) {
                const strengths = [];
                const answerLower = answer.toLowerCase();
                
                if (answer.length > 100) {
                    strengths.push("Has desenvolupat la resposta amb suficients detalls");
                }
                
                if (/[.!?]\s/.test(answer) && answer.split(/[.!?]\s/).length > 3) {
                    strengths.push("L'estructura de les frases √©s clara i variada");
                }
                
                if (/(primer|despr√©s|finalment|a continuaci√≥)/i.test(answer)) {
                    strengths.push("Has organitzat la informaci√≥ de manera seq√ºencial");
                }
                
                if (/(a m√©s|tamb√©|perqu√®|a causa de|per tant)/i.test(answer)) {
                    strengths.push("Utilitzes connectors per relacionar les teves idees");
                }
                
                const keywords = this.getKeywordsForQuestion(question.id);
                const matchedKeywords = keywords.filter(kw => answerLower.includes(kw));
                if (matchedKeywords.length >= 3) {
                    strengths.push("Has incl√≤s la majoria de conceptes clau del tema");
                }
                
                return strengths;
            },
            
            detectImprovements: function(answer, question) {
                const improvements = [];
                
                if (answer.length < 80) {
                    improvements.push("La resposta √©s massa breu; intenta desenvolupar m√©s les teves idees");
                }
                
                if (!/(a causa de|perqu√®|com a resultat|per tant)/i.test(answer)) {
                    improvements.push("Prova a explicar m√©s les relacions de causa-efecte");
                }
                
                if (!/(per exemple|com ara|per il¬∑lustrar)/i.test(answer)) {
                    improvements.push("Seria √∫til afegir exemples concrets per il¬∑lustrar les teves explicacions");
                }
                
                const keywords = this.getKeywordsForQuestion(question.id);
                const answerLower = answer.toLowerCase();
                const missingKeywords = keywords.filter(kw => !answerLower.includes(kw));
                
                if (missingKeywords.length > 0 && missingKeywords.length <= 3) {
                    improvements.push(`Considera mencionar: ${missingKeywords.slice(0, 3).join(', ')}`);
                }
                
                return improvements;
            },
            
            generateSuggestions: function(answer, question) {
                const suggestions = [];
                
                if (answer.length < 120) {
                    suggestions.push("Amplia la teva resposta explicant les conseq√º√®ncies dels fets que has mencionat");
                }
                
                if (!/(per tant|aix√≠ doncs|en conclusi√≥)/i.test(answer)) {
                    suggestions.push("Prova a afegir una petita conclusi√≥ que resumeixi les teves idees principals");
                }
                
                if (question.id === 'SA3') {
                    suggestions.push("Investiga sobre el rol dels califats Omeia i Abb√†ssida en l'expansi√≥");
                } else if (question.id === 'SA1') {
                    suggestions.push("Llegeix sobre com les invasions germ√†niques van afectar l'Imperi Rom√†");
                } else if (question.id === 'SA2') {
                    suggestions.push("Busca informaci√≥ sobre les difer√®ncies entre l'Imperi Rom√† d'Occident i el d'Orient");
                } else if (question.id === 'SA4') {
                    suggestions.push("Estudia com el Tractat de Verdun va influir en la formaci√≥ dels estats europeus moderns");
                }
                
                return suggestions;
            },
            
            compareWithModel: function(answer, question) {
                const answerLower = answer.toLowerCase();
                const modelLower = question.modelAnswer.toLowerCase();
                
                // Paraules clau del model
                const modelKeywords = this.extractKeywords(modelLower);
                const answerKeywords = this.extractKeywords(answerLower);
                
                const commonKeywords = modelKeywords.filter(kw => 
                    answerKeywords.includes(kw)
                );
                
                const missingKeywords = modelKeywords.filter(kw => 
                    !answerKeywords.includes(kw)
                );
                
                const extraKeywords = answerKeywords.filter(kw => 
                    !modelKeywords.includes(kw)
                );
                
                return {
                    common: commonKeywords.slice(0, 5),
                    missing: missingKeywords.slice(0, 3),
                    extra: extraKeywords.slice(0, 3),
                    coverage: Math.round((commonKeywords.length / modelKeywords.length) * 100)
                };
            },
            
            extractKeywords: function(text) {
                // Llista de paraules comuns a excloure
                const stopWords = ['el', 'la', 'els', 'les', 'un', 'una', 'uns', 'unes', 'de', 'del', 'al', 'i', 'o', 'per', 'amb', 'sense', 'sobre', 'sota', 'a', 'en', '√©s', 'son', 'era', 'eren', 'va', 'van', 'ha', 'han', 'aquest', 'aquesta', 'aquests', 'aquestes', 'que', 'qui', 'on', 'com', 'quan', 'perqu√®'];
                
                const words = text.split(/\W+/).filter(word => 
                    word.length > 3 && !stopWords.includes(word.toLowerCase())
                );
                
                return [...new Set(words)].slice(0, 15);
            },
            
            generateMotivation: function(score) {
                if (score >= 4) {
                    return "üèÜ Excel¬∑lent feina! Est√†s demostrant una gran comprensi√≥ del tema. Continua aix√≠!";
                } else if (score >= 3) {
                    return "üëç Molt bona feina! Cada vegada ho fas millor. Segueix practicant!";
                } else if (score >= 2) {
                    return "üí™ Bona base! Amb una mica m√©s de pr√†ctica, ho dominar√†s completament.";
                } else {
                    return "üå± Bon comen√ßament! Tots els experts van comen√ßar per algun lloc. Segueix aprenent!";
                }
            },
            
            calculateGrade: function(score) {
                if (score >= 4.5) return 'excellent';
                if (score >= 3.5) return 'notable';
                if (score >= 2.5) return 'good';
                if (score >= 1.5) return 'sufficient';
                return 'insufficient';
            }
        };
        
        function setupEventListeners() {
            // Bot√≥ per enviar resposta
            submitBtn.addEventListener('click', function() {
                const question = questions[currentQuestionIndex];
                let validAnswer = false;
                
                // Validar que s'hagi donat una resposta
                if (question.type === 'multiple-choice' || question.type === 'true-false') {
                    validAnswer = userAnswers[currentQuestionIndex] !== null;
                } else if (question.type === 'development') {
                    validAnswer = userAnswers[currentQuestionIndex] && userAnswers[currentQuestionIndex].trim() !== '';
                } else if (question.type === 'fill-blanks') {
                    validAnswer = userAnswers[currentQuestionIndex] && Object.keys(userAnswers[currentQuestionIndex]).length > 0;
                }
                
                if (!validAnswer) {
                    alert('Si us plau, respon la pregunta abans d\'enviar.');
                    return;
                }
                
                // Marcar com a enviada
                answerSubmitted[currentQuestionIndex] = true;
                
                // Processar la resposta
                let isCorrect = false;
                let feedbackData = null;
                let grade = '';
                
                if (question.type === 'multiple-choice' || question.type === 'true-false') {
                    isCorrect = userAnswers[currentQuestionIndex] === question.correctAnswer;
                    
                    if (isCorrect) {
                        grade = 'excellent';
                        // Desbloquejar ins√≠gnia
                        unlockedBadges[currentQuestionIndex] = true;
                        updateBadges();
                    } else {
                        grade = 'sufficient';
                    }
                    
                    // Feedback simple per a preguntes objectives
                    feedbackData = {
                        dimensions: {
                            content: isCorrect ? 5 : 2,
                            structure: 3,
                            vocabulary: 3,
                            depth: 3,
                            creativity: 3,
                            totalScore: isCorrect ? 4 : 2.5
                        },
                        strengths: isCorrect ? 
                            ["Has identificat correctament la resposta"] : 
                            ["Has intentat respondre la pregunta"],
                        improvements: isCorrect ? 
                            [] : 
                            ["Revisa el model de resposta per entendre millor el concepte"],
                        suggestions: isCorrect ? 
                            ["Continua aprenent!"] : 
                            ["Torna a llegir la pregunta amb atenci√≥"],
                        comparison: {
                            common: [],
                            missing: [],
                            extra: [],
                            coverage: isCorrect ? 100 : 50
                        },
                        motivation: isCorrect ? 
                            "‚úÖ Correcte! Has demostrat comprensi√≥ del concepte." : 
                            "üîç Gaireb√©! Revisa el model i torna a intentar-ho.",
                        grade: grade
                    };
                    
                } else if (question.type === 'fill-blanks') {
                    let correctCount = 0;
                    question.blanks.forEach(blank => {
                        const input = document.getElementById(blank.id);
                        if (input && input.value.toLowerCase() === blank.answer.toLowerCase()) {
                            correctCount++;
                        }
                    });
                    
                    const percentage = (correctCount / question.blanks.length) * 100;
                    isCorrect = percentage >= 60;
                    
                    if (isCorrect) {
                        // Desbloquejar ins√≠gnia
                        unlockedBadges[currentQuestionIndex] = true;
                        updateBadges();
                    }
                    
                    // Feedback per a emplenar buits
                    feedbackData = {
                        dimensions: {
                            content: percentage / 20, // Convertir a escala 0-5
                            structure: 4,
                            vocabulary: 3,
                            depth: 3,
                            creativity: 2,
                            totalScore: percentage / 20
                        },
                        strengths: [`Has encertat ${correctCount} de ${question.blanks.length} buits`],
                        improvements: percentage < 100 ? 
                            [`Intenta recordar els conceptes que t'han costat m√©s`] : 
                            [],
                        suggestions: ["Practica m√©s amb aquest tipus d'exercicis per millorar la teva mem√≤ria"],
                        comparison: {
                            common: [],
                            missing: [],
                            extra: [],
                            coverage: percentage
                        },
                        motivation: percentage >= 80 ? 
                            "üéØ Excel¬∑lent! Gaireb√© tots els buits correctes." :
                            percentage >= 60 ?
                            "üëç Bona feina! Has encertat la majoria." :
                            "üí™ Segueix practicant, ho far√†s millor la propera vegada.",
                        grade: this.calculateGrade(percentage / 20)
                    };
                    
                } else if (question.type === 'development') {
                    // Simular processament d'IA amb retard
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analitzant...';
                    
                    setTimeout(() => {
                        // An√†lisi amb el simulador d'IA
                        feedbackData = aiFeedbackSimulator.analyzeAnswer(
                            userAnswers[currentQuestionIndex], 
                            question,
                            userAnswers[currentQuestionIndex]
                        );
                        
                        // Desbloquejar ins√≠gnia si la qualificaci√≥ √©s suficient
                        if (feedbackData.dimensions.totalScore >= 3) {
                            unlockedBadges[currentQuestionIndex] = true;
                            updateBadges();
                        }
                        
                        displayAIFeedback(feedbackData);
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Envia la resposta';
                    }, 2000);
                    
                    return; // Sortir aqu√≠ i esperar el timeout
                }
                
                // Per a totes les preguntes excepte desenvolupament (que ja ha sortit)
                if (feedbackData) {
                    displayFeedback(feedbackData, question.type);
                }
                
                // Actualitzar la pregunta per mostrar el resultat
                loadQuestion(currentQuestionIndex);
            });
            
            // Botons de navegaci√≥
            nextBtn.addEventListener('click', function() {
                if (currentQuestionIndex < questions.length - 1) {
                    currentQuestionIndex++;
                    loadQuestion(currentQuestionIndex);
                }
            });
            
            prevBtn.addEventListener('click', function() {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    loadQuestion(currentQuestionIndex);
                }
            });
            
            // Bot√≥ per tornar a l'inici
            homeBtn.addEventListener('click', function() {
                showScreen(welcomeScreen);
            });
            
            // Bot√≥ per mostrar/amagar el model de resposta
            toggleModelBtn.addEventListener('click', function() {
                if (modelAnswerEl.style.display === 'none') {
                    modelAnswerEl.style.display = 'block';
                    toggleModelBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Amaga model de resposta';
                } else {
                    modelAnswerEl.style.display = 'none';
                    toggleModelBtn.innerHTML = '<i class="fas fa-eye"></i> Mostra model de resposta';
                }
            });
            
            // Botons d'accessibilitat
            contrastBtn.addEventListener('click', function() {
                document.body.classList.toggle('high-contrast');
            });
            
            textSizeBtn.addEventListener('click', function() {
                document.body.classList.toggle('large-text');
            });
            
            // Targetes de situacions d'aprenentatge
            situationCards.forEach(card => {
                card.addEventListener('click', function() {
                    const situationIndex = parseInt(this.getAttribute('data-situation'));
                    currentQuestionIndex = situationIndex;
                    loadQuestion(currentQuestionIndex);
                    showScreen(questionScreen);
                });
            });
        }
        
        function displayFeedback(feedbackData, questionType) {
            // Configurar la qualificaci√≥
            gradeIndicatorEl.textContent = `Qualificaci√≥: ${getGradeText(feedbackData.grade)}`;
            gradeIndicatorEl.className = `grade-indicator ${feedbackData.grade}`;
            
            // Configurar l'avaluaci√≥ multidimensional
            multidimensionalRatingEl.innerHTML = '';
            
            const dimensions = [
                { name: 'üìö Contingut', score: feedbackData.dimensions.content, color: '#4a6fa5' },
                { name: 'üèóÔ∏è Estructura', score: feedbackData.dimensions.structure, color: '#28a745' },
                { name: 'üî§ Vocabulari', score: feedbackData.dimensions.vocabulary, color: '#ffc107' },
                { name: 'üí° Profunditat', score: feedbackData.dimensions.depth, color: '#dc3545' },
                { name: 'üé® Creativitat', score: feedbackData.dimensions.creativity, color: '#6f42c1' }
            ];
            
            dimensions.forEach(dim => {
                const dimensionEl = document.createElement('div');
                dimensionEl.className = 'rating-dimension';
                
                dimensionEl.innerHTML = `
                    <div class="dimension-name">${dim.name}</div>
                    <div class="dimension-score">${dim.score}/5</div>
                    <div class="dimension-bar">
                        <div class="dimension-progress" style="width: ${(dim.score / 5) * 100}%; background-color: ${dim.color};"></div>
                    </div>
                `;
                
                multidimensionalRatingEl.appendChild(dimensionEl);
            });
            
            // Configurar el feedback de contingut
            let feedbackHTML = '';
            
            if (feedbackData.strengths.length > 0) {
                feedbackHTML += `<h3><i class="fas fa-check-circle" style="color: #28a745;"></i> Punts forts:</h3>`;
                feedbackHTML += `<ul class="strengths-list">`;
                feedbackData.strengths.forEach(strength => {
                    feedbackHTML += `<li>${strength}</li>`;
                });
                feedbackHTML += `</ul>`;
            }
            
            if (feedbackData.improvements.length > 0) {
                feedbackHTML += `<h3><i class="fas fa-sync-alt" style="color: #ffc107;"></i> √Ärees de millora:</h3>`;
                feedbackHTML += `<ul class="improvements-list">`;
                feedbackData.improvements.forEach(improvement => {
                    feedbackHTML += `<li>${improvement}</li>`;
                });
                feedbackHTML += `</ul>`;
            }
            
            if (feedbackData.suggestions.length > 0) {
                feedbackHTML += `<h3><i class="fas fa-lightbulb" style="color: #4a6fa5;"></i> Suggeriments:</h3>`;
                feedbackHTML += `<ul class="suggestions-list">`;
                feedbackData.suggestions.forEach(suggestion => {
                    feedbackHTML += `<li>${suggestion}</li>`;
                });
                feedbackHTML += `</ul>`;
            }
            
            feedbackContentEl.innerHTML = feedbackHTML;
            
            // Configurar l'an√†lisi comparativa
            if (feedbackData.comparison && questionType === 'development') {
                let comparisonHTML = `<h3><i class="fas fa-balance-scale"></i> Comparativa amb el model:</h3>`;
                comparisonHTML += `<p>Cobertura del contingut clau: <strong>${feedbackData.comparison.coverage}%</strong></p>`;
                
                if (feedbackData.comparison.common.length > 0) {
                    comparisonHTML += `<p><strong>Conceptes inclosos:</strong> ${feedbackData.comparison.common.join(', ')}</p>`;
                }
                
                if (feedbackData.comparison.missing.length > 0) {
                    comparisonHTML += `<p><strong>Conceptes a afegir:</strong> ${feedbackData.comparison.missing.join(', ')}</p>`;
                }
                
                if (feedbackData.comparison.extra.length > 0) {
                    comparisonHTML += `<p><strong>Elements addicionals:</strong> ${feedbackData.comparison.extra.join(', ')}</p>`;
                }
                
                comparisonAnalysisEl.innerHTML = comparisonHTML;
            } else {
                comparisonAnalysisEl.innerHTML = '';
            }
            
            // Configurar el missatge motivacional
            motivationalMessageEl.textContent = feedbackData.motivation;
            
            // Mostrar el feedback
            feedbackContainerEl.style.display = 'block';
        }
        
        function displayAIFeedback(feedbackData) {
            displayFeedback(feedbackData, 'development');
            // Actualitzar la pregunta per mostrar el resultat
            loadQuestion(currentQuestionIndex);
        }
        
        function getGradeText(grade) {
            const grades = {
                'insufficient': 'A millorar',
                'sufficient': 'Suficient',
                'good': 'B√©',
                'notable': 'Notable',
                'excellent': 'Excel¬∑lent'
            };
            return grades[grade];
        }
        
        function updateBadges() {
            badgeElements.forEach((badge, index) => {
                if (unlockedBadges[index]) {
                    badge.classList.remove('locked');
                    badge.classList.add('unlocked');
                    badge.title = questions[index].badge.name + " - Desbloquejada!";
                } else {
                    badge.classList.remove('unlocked');
                    badge.classList.add('locked');
                    badge.title = questions[index].badge.name + " - Bloquejada";
                }
            });
        }
    </script>
</body>
</html>