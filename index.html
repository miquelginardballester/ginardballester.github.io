<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q√ºestionari d'Hist√≤ria - 2n d'ESO</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-color: #f8f9fa;
            --dark-color: #343a40;
            --font-size-base: 16px;
            --font-size-lg: 18px;
            --font-size-xl: 20px;
            --line-height: 1.5;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: var(--font-size-base);
            line-height: var(--line-height);
            color: var(--dark-color);
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            padding: 30px;
            position: relative;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-color);
        }
        
        h1 {
            color: var(--primary-color);
            font-size: var(--font-size-xl);
            text-align: center;
            margin-bottom: 10px;
        }
        
        h2 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .welcome-container {
            text-align: center;
            padding: 30px 0;
        }
        
        .welcome-container p {
            margin-bottom: 20px;
            font-size: var(--font-size-lg);
            line-height: 1.6;
        }
        
        .situations-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 30px;
        }
        
        .situation-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 25px 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            background: white;
            position: relative;
            overflow: hidden;
        }
        
        .situation-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-color);
        }
        
        .situation-card:hover {
            border-color: var(--primary-color);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .situation-card i {
            font-size: 2.5rem;
            color: var(--primary-color);
            margin-bottom: 15px;
        }
        
        .situation-card h3 {
            margin-bottom: 10px;
            color: var(--secondary-color);
        }
        
        .progress-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .progress-bar {
            width: 200px;
            height: 12px;
            background-color: #e0e0e0;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .progress {
            height: 100%;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            width: 25%;
            transition: width 0.5s ease;
        }
        
        .question-info {
            background-color: var(--light-color);
            padding: 12px 18px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
            border-left: 4px solid var(--primary-color);
        }
        
        .question-text {
            font-size: var(--font-size-lg);
            margin-bottom: 25px;
            font-weight: 600;
            line-height: 1.6;
        }
        
        /* Estils per a preguntes d'opci√≥ m√∫ltiple */
        .options-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 25px;
        }
        
        .option {
            display: flex;
            align-items: flex-start;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: white;
        }
        
        .option:hover {
            border-color: var(--primary-color);
            background-color: #f0f7ff;
        }
        
        .option.selected {
            border-color: var(--primary-color);
            background-color: #e6f2ff;
        }
        
        .option.correct {
            border-color: var(--success-color);
            background-color: #e8f5e8;
        }
        
        .option.incorrect {
            border-color: var(--danger-color);
            background-color: #fde8e8;
        }
        
        .option input {
            margin-right: 12px;
            margin-top: 3px;
            transform: scale(1.2);
        }
        
        .option-label {
            font-weight: 500;
        }
        
        /* Estils per a preguntes vertader/fals */
        .true-false-container {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .true-false-option {
            flex: 1;
            text-align: center;
            padding: 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            background-color: white;
            font-size: 1.1rem;
        }
        
        .true-false-option:hover {
            border-color: var(--primary-color);
            background-color: #f0f7ff;
        }
        
        .true-false-option.selected.true {
            border-color: var(--success-color);
            background-color: #e8f5e8;
        }
        
        .true-false-option.selected.false {
            border-color: var(--danger-color);
            background-color: #fde8e8;
        }
        
        .true-false-option.correct {
            border-color: var(--success-color);
            background-color: #e8f5e8;
        }
        
        .true-false-option.incorrect {
            border-color: var(--danger-color);
            background-color: #fde8e8;
        }
        
        /* Estils per a preguntes de desenvolupament */
        .development-question {
            margin-bottom: 25px;
        }
        
        .development-textarea {
            width: 100%;
            min-height: 180px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: inherit;
            font-size: var(--font-size-base);
            line-height: var(--line-height);
            resize: vertical;
            transition: border-color 0.2s;
        }
        
        .development-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.1);
        }
        
        /* Estils per a preguntes d'emplenar buits */
        .fill-blanks-container {
            margin-bottom: 25px;
        }
        
        .fill-text {
            font-size: var(--font-size-base);
            line-height: 1.8;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }
        
        .blank-input {
            display: inline-block;
            width: 150px;
            padding: 8px 12px;
            border: 1px dashed #aaa;
            border-radius: 4px;
            background-color: #fff;
            margin: 0 5px;
            text-align: center;
        }
        
        .blank-input.correct {
            border: 2px solid var(--success-color);
            background-color: #e8f5e8;
        }
        
        .blank-input.incorrect {
            border: 2px solid var(--danger-color);
            background-color: #fde8e8;
        }
        
        /* Botons */
        .button-container {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .submit-btn {
            background-color: var(--primary-color);
            color: white;
        }
        
        .submit-btn:hover {
            background-color: var(--secondary-color);
        }
        
        .next-btn {
            background-color: var(--success-color);
            color: white;
        }
        
        .next-btn:hover {
            background-color: #218838;
        }
        
        .prev-btn {
            background-color: #6c757d;
            color: white;
        }
        
        .prev-btn:hover {
            background-color: #5a6268;
        }
        
        .home-btn {
            background-color: #6c757d;
            color: white;
        }
        
        .home-btn:hover {
            background-color: #5a6268;
        }
        
        /* Feedback Millorat - REAL I FUNCIONAL */
        .feedback-container {
            margin-top: 20px;
            padding: 25px;
            border-radius: 10px;
            background: linear-gradient(135deg, #e8f4f8 0%, #d4edda 100%);
            border-left: 6px solid var(--primary-color);
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .feedback-title {
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.2rem;
        }
        
        .feedback-content {
            line-height: 1.7;
        }
        
        .feedback-message {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 8px;
        }
        
        .feedback-correct {
            background-color: #d4edda;
            color: var(--success-color);
            border-left: 4px solid var(--success-color);
        }
        
        .feedback-incorrect {
            background-color: #f8d7da;
            color: var(--danger-color);
            border-left: 4px solid var(--danger-color);
        }
        
        .feedback-section {
            margin: 15px 0;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .feedback-section h3 {
            color: var(--secondary-color);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .strengths-list, .improvements-list, .suggestions-list {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .strengths-list li, .improvements-list li, .suggestions-list li {
            margin-bottom: 8px;
            line-height: 1.5;
        }
        
        .strengths-list li::marker {
            color: var(--success-color);
            content: '‚úì ';
        }
        
        .improvements-list li::marker {
            color: var(--warning-color);
            content: '‚Üª ';
        }
        
        .suggestions-list li::marker {
            color: var(--primary-color);
            content: 'üí° ';
        }
        
        .concept-analysis {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
        }
        
        .concepts-included, .concepts-missing {
            padding: 15px;
            border-radius: 8px;
        }
        
        .concepts-included {
            background: #e8f5e8;
            border-left: 4px solid var(--success-color);
        }
        
        .concepts-missing {
            background: #fff3cd;
            border-left: 4px solid var(--warning-color);
        }
        
        .concept-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .concept-tag {
            padding: 5px 10px;
            background: white;
            border-radius: 20px;
            font-size: 0.9rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .concept-tag.included {
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }
        
        .concept-tag.missing {
            border: 1px solid var(--warning-color);
            color: var(--warning-color);
        }
        
        .badge-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .badge {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #4a6fa5, #166088);
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }
        
        .badge.locked {
            background: linear-gradient(135deg, #ccc, #999);
            opacity: 0.6;
        }
        
        .badge.unlocked {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.3);
        }
        
        .model-answer {
            margin-top: 20px;
            padding: 20px;
            background-color: #f0f8ff;
            border-radius: 10px;
            border-left: 6px solid #4a6fa5;
            display: none;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        .model-answer-title {
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }
        
        .toggle-model-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            font-weight: 600;
            padding: 8px 0;
            margin-top: 10px;
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 1rem;
        }
        
        .toggle-model-btn:hover {
            color: var(--secondary-color);
        }
        
        /* Millores d'accessibilitat */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .accessibility-options {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .accessibility-btn {
            background: none;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px 10px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .high-contrast {
            color: #000;
            background-color: #fff;
        }
        
        .large-text {
            font-size: 20px;
        }
        
        /* Pantalles */
        .screen {
            display: none;
        }
        
        .active {
            display: block;
        }
        
        /* Responsivitat */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .true-false-container {
                flex-direction: column;
            }
            
            .concept-analysis {
                grid-template-columns: 1fr;
            }
            
            .grade-levels {
                flex-direction: column;
                gap: 5px;
            }
            
            header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .progress-container {
                width: 100%;
            }
            
            .progress-bar {
                flex-grow: 1;
            }
            
            .situations-container {
                grid-template-columns: 1fr;
            }
            
            .button-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .button-container button {
                width: 100%;
                justify-content: center;
            }
            
            .badge-container {
                flex-wrap: wrap;
            }
        }
        
        .result-correct {
            color: var(--success-color);
            font-weight: bold;
            margin-top: 10px;
            font-size: 1.1rem;
        }
        
        .result-incorrect {
            color: var(--danger-color);
            font-weight: bold;
            margin-top: 10px;
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="accessibility-options">
            <button class="accessibility-btn" id="contrast-btn">
                <i class="fas fa-adjust"></i> Alt contrast
            </button>
            <button class="accessibility-btn" id="text-size-btn">
                <i class="fas fa-text-height"></i> Text gran
            </button>
        </div>
        
        <!-- Pantalla de benvinguda -->
        <div class="screen active" id="welcome-screen">
            <div class="welcome-container">
                <h1>Q√ºestionari d'Hist√≤ria - 2n d'ESO</h1>
                <p>Benvingut/da al q√ºestionari d'Hist√≤ria de 2n d'ESO. Aqu√≠ podr√†s repassar els continguts de les quatre situacions d'aprenentatge del curs.</p>
                <p>Selecciona una de les situacions d'aprenentatge per comen√ßar:</p>
                
                <div class="situations-container">
                    <div class="situation-card" data-situation="0">
                        <i class="fas fa-landmark"></i>
                        <h3>Caiguda de l'Imperi Rom√†</h3>
                        <p>Analitza les causes i conseq√º√®ncies de la caiguda de l'Imperi Rom√† d'Occident</p>
                    </div>
                    <div class="situation-card" data-situation="1">
                        <i class="fas fa-chess-rook"></i>
                        <h3>Imperi Bizant√≠</h3>
                        <p>Descobreix l'Imperi Rom√† d'Orient i la seva import√†ncia hist√≤rica</p>
                    </div>
                    <div class="situation-card" data-situation="2">
                        <i class="fas fa-mosque"></i>
                        <h3>Imperi Isl√†mic</h3>
                        <p>Explora l'expansi√≥ i l'her√®ncia de l'Imperi Isl√†mic</p>
                    </div>
                    <div class="situation-card" data-situation="3">
                        <i class="fas fa-crown"></i>
                        <h3>Imperi Carolingi</h3>
                        <p>Con√®ixer l'Imperi de Carlemany i el seu llegat</p>
                    </div>
                </div>
                
                <div class="badge-container">
                    <div class="badge locked" title="Expert en Roma - Bloquejada">
                        <i class="fas fa-landmark"></i>
                    </div>
                    <div class="badge locked" title="Coneixedor Bizant√≠ - Bloquejada">
                        <i class="fas fa-chess-rook"></i>
                    </div>
                    <div class="badge locked" title="Erudit Isl√†mic - Bloquejada">
                        <i class="fas fa-mosque"></i>
                    </div>
                    <div class="badge locked" title="Mestre Carolingi - Bloquejada">
                        <i class="fas fa-crown"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Pantalla de pregunta -->
        <div class="screen" id="question-screen">
            <header>
                <button class="home-btn" id="home-btn">
                    <i class="fas fa-home"></i> Torna a l'inici
                </button>
                <div class="progress-container">
                    <span>Progr√©s:</span>
                    <div class="progress-bar">
                        <div class="progress" id="progress-bar"></div>
                    </div>
                    <span id="progress-text">1/4</span>
                </div>
            </header>
            
            <div class="question-info" id="question-info">Caiguda de l'Imperi Rom√† - 1/4</div>
            
            <div class="question-text" id="question-text">
                <!-- El text de la pregunta es carregar√† din√†micament -->
            </div>
            
            <div id="question-content">
                <!-- El contingut de la pregunta (opcions, textarea, etc.) es carregar√† din√†micament -->
            </div>
            
            <button class="toggle-model-btn" id="toggle-model-btn">
                <i class="fas fa-eye"></i> Mostra model de resposta
            </button>
            
            <div class="model-answer" id="model-answer">
                <div class="model-answer-title">
                    <i class="fas fa-lightbulb"></i> Model de resposta
                </div>
                <div id="model-answer-content">
                    <!-- El contingut del model es carregar√† din√†micament -->
                </div>
            </div>
            
            <div class="feedback-container" id="feedback-container">
                <div class="feedback-title">
                    <i class="fas fa-robot"></i> An√†lisi de la teva resposta
                </div>
                
                <div id="feedback-content">
                    <!-- El contingut del feedback es carregar√† din√†micament -->
                </div>
            </div>
            
            <div class="button-container">
                <button class="prev-btn" id="prev-btn">
                    <i class="fas fa-arrow-left"></i> Anterior
                </button>
                <button class="submit-btn" id="submit-btn">
                    <i class="fas fa-paper-plane"></i> Envia la resposta
                </button>
                <button class="next-btn" id="next-btn">
                    Seg√ºent <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Dades completes del q√ºestionari - 4 SA amb 4 preguntes cadascuna
        const situations = [
            {
                id: "SA1",
                title: "Caiguda de l'Imperi Rom√†",
                badge: { name: "üèõÔ∏è Expert en Roma", icon: "fas fa-landmark" },
                questions: [
                    {
                        id: "SA1-P1",
                        type: "multiple-choice",
                        text: "Quin dels seg√ºents factors va ser una causa pol√≠tica de la crisi de l'Imperi Rom√† d'Occident?",
                        options: [
                            "La p√®rdua de terres cultivables per l'erosi√≥.",
                            "La inestabilitat i les guerres civils per la successi√≥ imperial.",
                            "La importaci√≥ massiva de seda de la Xina.",
                            "L'aparici√≥ de noves tecnologies militars."
                        ],
                        correctAnswer: 1,
                        modelAnswer: "La resposta correcta √©s: <strong>La inestabilitat i les guerres civils per la successi√≥ imperial</strong>. Aquest factor √©s una causa pol√≠tica perqu√® afecta directament la manera com es governa l'imperi. Les lluites per el poder entre diferents faccions i la manca d'un sistema clar de successi√≥ feien que l'imperi estigu√©s constantment debilitat per conflictes interns."
                    },
                    {
                        id: "SA1-P2",
                        type: "true-false",
                        text: "La divisi√≥ de l'Imperi Rom√† en Orient i Occident va afeblir considerablement l'Imperi d'Occident.",
                        correctAnswer: true,
                        modelAnswer: "La resposta correcta √©s: <strong>Vertader</strong>. La divisi√≥ de l'imperi va debilitar l'Occident perqu√® les regions m√©s riques i desenvolupades es trobaven a l'Orient (Constantinoble), mentre que l'Occident tenia m√©s dificultats econ√≤miques i era m√©s vulnerable als atacs dels pobles germ√†nics."
                    },
                    {
                        id: "SA1-P3",
                        type: "development",
                        text: "Explica com les invasions germ√†niques van contribuir a la caiguda de l'Imperi Rom√† d'Occident.",
                        modelAnswer: "Les invasions germ√†niques van ser un factor clau en la caiguda de l'Imperi Rom√† d'Occident. Diversos pobles germ√†nics, com els visigots, vandals, francs i ostrogots, van creuar les fronteres de l'imperi pressionats pels huns. Aquestes invasions van tenir diversos efectes:<br><br>1. <strong>Pressi√≥ militar constant</strong>: L'ex√®rcit rom√† no podia defensar totes les fronteres.<br>2. <strong>P√®rdua de territoris</strong>: Els germ√†nics van establir regnes independients dins de l'imperi.<br>3. <strong>Debilitat econ√≤mica</strong>: Les invasions van interrompre el comer√ß i la producci√≥ agr√†ria.<br>4. <strong>Fragilitat pol√≠tica</strong>: Els l√≠ders germ√†nics van adquirir cada vegada m√©s poder."
                    },
                    {
                        id: "SA1-P4",
                        type: "fill-blanks",
                        text: "Completa els buits en el seg√ºent text sobre la caiguda de l'Imperi Rom√†:",
                        fillText: "L'Imperi Rom√† d'Occident va caure l'any <input type='text' class='blank-input' id='blank1'>. Entre les causes de la seva caiguda hi ha les <input type='text' class='blank-input' id='blank2'> civils, les invasions <input type='text' class='blank-input' id='blank3'> i la crisi <input type='text' class='blank-input' id='blank4'>. L'√∫ltim emperador rom√† d'Occident va ser <input type='text' class='blank-input' id='blank5'>.",
                        blanks: [
                            { id: "blank1", answer: "476" },
                            { id: "blank2", answer: "guerres" },
                            { id: "blank3", answer: "germ√†niques" },
                            { id: "blank4", answer: "econ√≤mica" },
                            { id: "blank5", answer: "R√≤mul Aug√∫stul" }
                        ],
                        modelAnswer: "Les respostes correctes s√≥n:<br><br>1. <strong>476</strong> (any de la caiguda)<br>2. <strong>guerres</strong> (civils)<br>3. <strong>germ√†niques</strong> (invasions)<br>4. <strong>econ√≤mica</strong> (crisi)<br>5. <strong>R√≤mul Aug√∫stul</strong> (√∫ltim emperador)<br><br>Aquests factors combinats van portar a la desintegraci√≥ de l'Imperi Rom√† d'Occident, marcant el final de l'Edat Antiga i l'inici de l'Edat Mitjana."
                    }
                ]
            },
            {
                id: "SA2",
                title: "Imperi Bizant√≠",
                badge: { name: "üëë Coneixedor Bizant√≠", icon: "fas fa-chess-rook" },
                questions: [
                    {
                        id: "SA2-P1",
                        type: "multiple-choice",
                        text: "Quina va ser la capital de l'Imperi Bizant√≠?",
                        options: [
                            "Roma",
                            "Atenes",
                            "Constantinoble", 
                            "Alexandria"
                        ],
                        correctAnswer: 2,
                        modelAnswer: "La resposta correcta √©s: <strong>Constantinoble</strong>. Fundada per l'emperador Constant√≠ el Gran, Constantinoble (actual Istanbul) va ser la capital de l'Imperi Bizant√≠ i un centre cultural, econ√≤mic i pol√≠tic clau durant m√©s de mil anys."
                    },
                    {
                        id: "SA2-P2", 
                        type: "true-false",
                        text: "L'Imperi Bizant√≠ va mantenir el llat√≠ com a llengua oficial durant tot la seva exist√®ncia.",
                        correctAnswer: false,
                        modelAnswer: "La resposta correcta √©s: <strong>Fals</strong>. Encara que inicialment es va mantenir el llat√≠ com a llengua de l'administraci√≥, amb el temps el grec es va convertir en la llengua predominant de l'Imperi Bizant√≠, tant en l'administraci√≥ com en la cultura i la religi√≥."
                    },
                    {
                        id: "SA2-P3",
                        type: "development", 
                        text: "Explica la import√†ncia de l'Imperi Bizant√≠ com a pont entre l'antiguitat cl√†ssica i l'edat mitjana.",
                        modelAnswer: "L'Imperi Bizant√≠ va tenir un paper crucial com a pont entre l'antiguitat cl√†ssica i l'edat mitjana. Va preservar i transmetre l'her√®ncia cultural grecoromana mentre desenvolupava la seva pr√≤pia identitat. Els seus principals aportacions van ser:<br><br>1. <strong>Preservaci√≥ del saber</strong>: Van conservar i copiar obres cl√†ssiques gregues i romanes.<br>2. <strong>Desenvolupament del dret</strong>: El Codi de Justini√† va recopilar i sistematizar el dret rom√†.<br>3. <strong>Transmissi√≥ cultural</strong>: Van transmetre coneixements cl√†ssics a Europa i el m√≥n isl√†mic.<br>4. <strong>Defensa d'Europa</strong>: Van ser una barrera contra les invasions perses i √†rabs."
                    },
                    {
                        id: "SA2-P4",
                        type: "fill-blanks",
                        text: "Completa els buits sobre l'Imperi Bizant√≠:",
                        fillText: "L'Imperi Bizant√≠ es va originar amb la divisi√≥ de l'Imperi Rom√† l'any <input type='text' class='blank-input' id='blank6'>. El seu emperador m√©s important va ser <input type='text' class='blank-input' id='blank7'>, qui va compilar el <input type='text' class='blank-input' id='blank8'>. L'imperi va caure quan els <input type='text' class='blank-input' id='blank9'> van conquerir Constantinoble l'any <input type='text' class='blank-input' id='blank10'>.",
                        blanks: [
                            { id: "blank6", answer: "395" },
                            { id: "blank7", answer: "Justini√†" },
                            { id: "blank8", answer: "Codi de Justini√†" },
                            { id: "blank9", answer: "otomans" },
                            { id: "blank10", answer: "1453" }
                        ],
                        modelAnswer: "Les respostes correctes s√≥n:<br><br>1. <strong>395</strong> (any de la divisi√≥)<br>2. <strong>Justini√†</strong> (emperador)<br>3. <strong>Codi de Justini√†</strong> (compilaci√≥ legal)<br>4. <strong>otomans</strong> (conqueridors)<br>5. <strong>1453</strong> (any de la caiguda)<br><br>L'Imperi Bizant√≠ va existir durant m√©s de mil anys, preservant la cultura cl√†ssica i servint d'enlla√ß entre l'antiguitat i el Renaixement."
                    }
                ]
            },
            {
                id: "SA3",
                title: "Imperi Isl√†mic",
                badge: { name: "üìú Erudit Isl√†mic", icon: "fas fa-mosque" },
                questions: [
                    {
                        id: "SA3-P1",
                        type: "multiple-choice",
                        text: "On va n√©ixer Mahoma, fundador de l'islam?",
                        options: [
                            "Medina",
                            "Damasc",
                            "La Meca",
                            "Bagdad"
                        ],
                        correctAnswer: 2,
                        modelAnswer: "La resposta correcta √©s: <strong>La Meca</strong>. Mahoma va n√©ixer a La Meca l'any 570 dC. Aquesta ciutat es va convertir en el lloc m√©s sagrat de l'islam i centre de pelegrinatge per als musulmans."
                    },
                    {
                        id: "SA3-P2",
                        type: "true-false",
                        text: "L'expansi√≥ de l'Imperi Isl√†mic va ser nom√©s militar i no va incloure aspectes culturals o comercials.",
                        correctAnswer: false,
                        modelAnswer: "La resposta correcta √©s: <strong>Fals</strong>. L'expansi√≥ isl√†mica va ser un proc√©s complex que inclo√Øa no nom√©s conquestes militars, sin√≥ tamb√© intercanvis comercials, difusi√≥ cultural, i toler√†ncia religiosa cap a les 'gentes del llibre' (cristians i jueus)."
                    },
                    {
                        id: "SA3-P3",
                        type: "development",
                        text: "Explica els factors que van permetre la r√†pida expansi√≥ de l'Imperi Isl√†mic durant els segles VII i VIII.",
                        modelAnswer: "La r√†pida expansi√≥ de l'Imperi Isl√†mic es va deure a diversos factors clau:<br><br>1. <strong>Unificaci√≥ √†rab</strong>: L'islam va unificar les tribus √†rabs sota una mateixa fe.<br>2. <strong>Debilitat dels imperis ve√Øns</strong>: L'Imperi Bizant√≠ i l'Imperi Sass√†nida estaven afeblits per guerres entre ells.<br>3. <strong>Toler√†ncia religiosa</strong>: Els musulmans eren tolerants amb cristians i jueus, facilitant les conquestes.<br>4. <strong>Incentius econ√≤mics</strong>: Les conquestes oferien bot√≠ i noves terres.<br>5. <strong>Estrat√®gia militar</strong>: Mobilitat i t√†ctiques efectives dels ex√®rcits √†rabs."
                    },
                    {
                        id: "SA3-P4",
                        type: "fill-blanks",
                        text: "Completa els buits sobre l'expansi√≥ de l'Imperi Isl√†mic:",
                        fillText: "L'any de la H√®gira, quan Mahoma va fugir de La Meca a Medina, va ser l'any <input type='text' class='blank-input' id='blank11'>. Els successors de Mahoma es van anomenar <input type='text' class='blank-input' id='blank12'>. L'Imperi Isl√†mic va arribar a la Pen√≠nsula Ib√®rica l'any <input type='text' class='blank-input' id='blank13'> i va ser aturat a la Batalla de <input type='text' class='blank-input' id='blank14'> l'any 732. La dinastia que va governar a Al-√Ändalus va ser la <input type='text' class='blank-input' id='blank15'>.",
                        blanks: [
                            { id: "blank11", answer: "622" },
                            { id: "blank12", answer: "califes" },
                            { id: "blank13", answer: "711" },
                            { id: "blank14", answer: "Poitiers" },
                            { id: "blank15", answer: "Omeia" }
                        ],
                        modelAnswer: "Les respostes correctes s√≥n:<br><br>1. <strong>622</strong> (any de la H√®gira)<br>2. <strong>califes</strong> (successors)<br>3. <strong>711</strong> (arribada a la Pen√≠nsula Ib√®rica)<br>4. <strong>Poitiers</strong> (batalla)<br>5. <strong>Omeia</strong> (dinastia)<br><br>Aquesta expansi√≥ va permetre la creaci√≥ d'un vast imperi que va estendre la cultura isl√†mica des d'Espanya fins a l'√çndia."
                    }
                ]
            },
            {
                id: "SA4",
                title: "Imperi Carolingi",
                badge: { name: "‚öîÔ∏è Mestre Carolingi", icon: "fas fa-crown" },
                questions: [
                    {
                        id: "SA4-P1",
                        type: "multiple-choice",
                        text: "Quin papa va coronar Carlemany com a emperador?",
                        options: [
                            "Gregori I",
                            "Lle√≥ III",
                            "Esteve II",
                            "Nicolau I"
                        ],
                        correctAnswer: 1,
                        modelAnswer: "La resposta correcta √©s: <strong>Lle√≥ III</strong>. El papa Lle√≥ III va coronar Carlemany com a emperador el dia de Nadal de l'any 800, marcant el naixement de l'Imperi Carolingi i el restabliment de la dignitat imperial a Occident."
                    },
                    {
                        id: "SA4-P2",
                        type: "true-false",
                        text: "L'Imperi Carolingi va durar m√©s de 500 anys despr√©s de la mort de Carlemany.",
                        correctAnswer: false,
                        modelAnswer: "La resposta correcta √©s: <strong>Fals</strong>. L'Imperi Carolingi va comen√ßar a fragmentar-se poc despr√©s de la mort de Carlemany el 814. El Tractat de Verdun del 843 va dividir l'imperi entre els seus nets, posant fi a la unitat carol√≠ngia."
                    },
                    {
                        id: "SA4-P3",
                        type: "development",
                        text: "Explica en qu√® va consistir el 'Renaixement Carolingi' i la seva import√†ncia.",
                        modelAnswer: "El 'Renaixement Carolingi' va ser un per√≠ode de renovaci√≥ cultural i intel¬∑lectual promogut per Carlemany i els seus successors. Els seus aspectes m√©s importants van ser:<br><br>1. <strong>Reforma educativa</strong>: Es van crear escoles a monestirs i palaus.<br>2. <strong>Preservaci√≥ de textos</strong>: Es van copiar i preservar obres cl√†ssiques.<br>3. <strong>Desenvolupament de l'escriptura</strong>: Es va crear la min√∫scula carol√≠ngia, base de les lletres modernes.<br>4. <strong>Arquitectura</strong>: Es van construir esgl√©sies i monestirs amb estil propi.<br>5. <strong>Reforma religiosa</strong>: Es va unificar la lit√∫rgia i les pr√†ctiques eclesi√†stiques."
                    },
                    {
                        id: "SA4-P4",
                        type: "fill-blanks",
                        text: "Completa els buits sobre l'Imperi Carolingi:",
                        fillText: "Carlemany va ser coronat emperador l'any <input type='text' class='blank-input' id='blank16'>. El seu imperi es va dividir amb el <input type='text' class='blank-input' id='blank17'> de Verdun l'any 843. Els seus tres nets van repartir-se l'imperi: <input type='text' class='blank-input' id='blank18'> va obtenir la part oriental, <input type='text' class='blank-input' id='blank19'> la part occidental, i <input type='text' class='blank-input' id='blank20'> la part central.",
                        blanks: [
                            { id: "blank16", answer: "800" },
                            { id: "blank17", answer: "Tractat" },
                            { id: "blank18", answer: "Llu√≠s el Germ√†nic" },
                            { id: "blank19", answer: "Carles el Calb" },
                            { id: "blank20", answer: "Lotari" }
                        ],
                        modelAnswer: "Les respostes correctes s√≥n:<br><br>1. <strong>800</strong> (any de la coronaci√≥)<br>2. <strong>Tractat</strong> (de Verdun)<br>3. <strong>Llu√≠s el Germ√†nic</strong> (part oriental)<br>4. <strong>Carles el Calb</strong> (part occidental)<br>5. <strong>Lotari</strong> (part central)<br><br>Aquesta divisi√≥ va marcar els or√≠gens dels futurs regnes d'Alemanya, Fran√ßa i It√†lia, i va posar fi a la unitat de l'Imperi Carolingi."
                    }
                ]
            }
        ];

        // Variables d'estat
        let currentSituationIndex = 0;
        let currentQuestionIndex = 0;
        let userAnswers = situations.map(sa => sa.questions.map(() => null));
        let answerSubmitted = situations.map(sa => sa.questions.map(() => false));
        let unlockedBadges = Array(situations.length).fill(false);
        
        // Elements del DOM
        const welcomeScreen = document.getElementById('welcome-screen');
        const questionScreen = document.getElementById('question-screen');
        const questionInfoEl = document.getElementById('question-info');
        const questionTextEl = document.getElementById('question-text');
        const questionContentEl = document.getElementById('question-content');
        const progressBarEl = document.getElementById('progress-bar');
        const progressTextEl = document.getElementById('progress-text');
        const submitBtn = document.getElementById('submit-btn');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const homeBtn = document.getElementById('home-btn');
        const feedbackContainerEl = document.getElementById('feedback-container');
        const feedbackContentEl = document.getElementById('feedback-content');
        const modelAnswerEl = document.getElementById('model-answer');
        const modelAnswerContentEl = document.getElementById('model-answer-content');
        const toggleModelBtn = document.getElementById('toggle-model-btn');
        const contrastBtn = document.getElementById('contrast-btn');
        const textSizeBtn = document.getElementById('text-size-btn');
        const situationCards = document.querySelectorAll('.situation-card');
        const badgeElements = document.querySelectorAll('.badge');
        
        // Inicialitzaci√≥
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateBadges();
        });
        
        function showScreen(screen) {
            // Amagar totes les pantalles
            document.querySelectorAll('.screen').forEach(s => {
                s.classList.remove('active');
            });
            
            // Mostrar la pantalla sol¬∑licitada
            screen.classList.add('active');
        }
        
        function loadQuestion(situationIndex, questionIndex) {
            const situation = situations[situationIndex];
            const question = situation.questions[questionIndex];
            
            // Actualitzar informaci√≥ de la pregunta
            questionInfoEl.textContent = `${situation.title} - ${questionIndex + 1}/${situation.questions.length}`;
            questionTextEl.textContent = question.text;
            
            // Actualitzar barra de progr√©s
            const progressPercentage = ((questionIndex + 1) / situation.questions.length) * 100;
            progressBarEl.style.width = `${progressPercentage}%`;
            progressTextEl.textContent = `${questionIndex + 1}/${situation.questions.length}`;
            
            // Configurar el contingut segons el tipus de pregunta
            questionContentEl.innerHTML = '';
            
            if (question.type === 'multiple-choice') {
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'options-container';
                
                question.options.forEach((option, i) => {
                    const optionEl = document.createElement('div');
                    let optionClass = 'option';
                    
                    if (answerSubmitted[situationIndex][questionIndex]) {
                        if (i === question.correctAnswer) {
                            optionClass += ' correct';
                        } else if (userAnswers[situationIndex][questionIndex] === i) {
                            optionClass += ' incorrect';
                        }
                    } else if (userAnswers[situationIndex][questionIndex] === i) {
                        optionClass += ' selected';
                    }
                    
                    optionEl.className = optionClass;
                    optionEl.innerHTML = `
                        <input type="radio" id="option${i+1}" name="question" value="${i}" 
                            ${userAnswers[situationIndex][questionIndex] === i ? 'checked' : ''} 
                            ${answerSubmitted[situationIndex][questionIndex] ? 'disabled' : ''}>
                        <label for="option${i+1}" class="option-label">${option}</label>
                    `;
                    optionsContainer.appendChild(optionEl);
                });
                
                questionContentEl.appendChild(optionsContainer);
                
            } else if (question.type === 'true-false') {
                const trueFalseContainer = document.createElement('div');
                trueFalseContainer.className = 'true-false-container';
                
                let trueClass = 'true-false-option true';
                let falseClass = 'true-false-option false';
                
                if (answerSubmitted[situationIndex][questionIndex]) {
                    if (question.correctAnswer === true) {
                        trueClass += ' correct';
                        falseClass += ' incorrect';
                    } else {
                        trueClass += ' incorrect';
                        falseClass += ' correct';
                    }
                } else {
                    if (userAnswers[situationIndex][questionIndex] === true) trueClass += ' selected';
                    if (userAnswers[situationIndex][questionIndex] === false) falseClass += ' selected';
                }
                
                trueFalseContainer.innerHTML = `
                    <div class="${trueClass}" data-value="true" ${answerSubmitted[situationIndex][questionIndex] ? 'style="pointer-events:none;"' : ''}>
                        Vertader
                    </div>
                    <div class="${falseClass}" data-value="false" ${answerSubmitted[situationIndex][questionIndex] ? 'style="pointer-events:none;"' : ''}>
                        Fals
                    </div>
                `;
                
                questionContentEl.appendChild(trueFalseContainer);
                
            } else if (question.type === 'development') {
                const developmentContainer = document.createElement('div');
                developmentContainer.className = 'development-question';
                
                developmentContainer.innerHTML = `
                    <textarea class="development-textarea" placeholder="Escriu la teva resposta aqu√≠..." 
                        ${answerSubmitted[situationIndex][questionIndex] ? 'disabled' : ''}>${userAnswers[situationIndex][questionIndex] || ''}</textarea>
                `;
                
                questionContentEl.appendChild(developmentContainer);
                
            } else if (question.type === 'fill-blanks') {
                const fillContainer = document.createElement('div');
                fillContainer.className = 'fill-blanks-container';
                
                let fillHTML = `<div class="fill-text">${question.fillText}</div>`;
                
                fillContainer.innerHTML = fillHTML;
                questionContentEl.appendChild(fillContainer);
                
                // Configurar els inputs dels buits
                question.blanks.forEach(blank => {
                    const input = document.getElementById(blank.id);
                    if (input) {
                        if (userAnswers[situationIndex][questionIndex] && userAnswers[situationIndex][questionIndex][blank.id]) {
                            input.value = userAnswers[situationIndex][questionIndex][blank.id];
                        }
                        
                        if (answerSubmitted[situationIndex][questionIndex]) {
                            input.disabled = true;
                            if (input.value.toLowerCase() === blank.answer.toLowerCase()) {
                                input.classList.add('correct');
                            } else {
                                input.classList.add('incorrect');
                            }
                        }
                        
                        input.addEventListener('input', function() {
                            if (!userAnswers[situationIndex][questionIndex]) {
                                userAnswers[situationIndex][questionIndex] = {};
                            }
                            userAnswers[situationIndex][questionIndex][blank.id] = this.value;
                        });
                    }
                });
            }
            
            // Actualitzar model de resposta
            modelAnswerContentEl.innerHTML = question.modelAnswer;
            
            // Amagar feedback i model de resposta per defecte
            feedbackContainerEl.style.display = 'none';
            modelAnswerEl.style.display = 'none';
            toggleModelBtn.innerHTML = '<i class="fas fa-eye"></i> Mostra model de resposta';
            
            // Actualitzar visibilitat dels botons
            prevBtn.style.display = questionIndex === 0 ? 'none' : 'flex';
            nextBtn.style.display = questionIndex === situation.questions.length - 1 ? 'none' : 'flex';
            submitBtn.style.display = answerSubmitted[situationIndex][questionIndex] ? 'none' : 'flex';
            
            // Configurar events per a les opcions (si no s'ha enviat)
            if (!answerSubmitted[situationIndex][questionIndex]) {
                setupQuestionEvents(situationIndex, questionIndex, question.type);
            }
        }
        
        function setupQuestionEvents(situationIndex, questionIndex, type) {
            if (type === 'multiple-choice') {
                const options = document.querySelectorAll('.option');
                options.forEach(option => {
                    option.addEventListener('click', function() {
                        if (answerSubmitted[situationIndex][questionIndex]) return;
                        
                        const radioInput = this.querySelector('input[type="radio"]');
                        radioInput.checked = true;
                        
                        options.forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');
                        
                        userAnswers[situationIndex][questionIndex] = parseInt(radioInput.value);
                    });
                });
            } else if (type === 'true-false') {
                const trueFalseOptions = document.querySelectorAll('.true-false-option');
                trueFalseOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        if (answerSubmitted[situationIndex][questionIndex]) return;
                        
                        const value = this.getAttribute('data-value') === 'true';
                        
                        trueFalseOptions.forEach(opt => {
                            opt.classList.remove('selected');
                        });
                        
                        this.classList.add('selected');
                        userAnswers[situationIndex][questionIndex] = value;
                    });
                });
            } else if (type === 'development') {
                const textarea = document.querySelector('.development-textarea');
                textarea.addEventListener('input', function() {
                    userAnswers[situationIndex][questionIndex] = this.value;
                });
            }
            // Per a 'fill-blanks', els events ja s'han configurat a loadQuestion
        }
        
        // Sistema de feedback avan√ßat i funcional
        const feedbackSystem = {
            // Feedback per a preguntes objectives
            generateObjectiveFeedback: function(userAnswer, correctAnswer, question, questionType) {
                const isCorrect = userAnswer === correctAnswer;
                let feedbackHTML = '';
                
                if (isCorrect) {
                    feedbackHTML += `
                        <div class="feedback-message feedback-correct">
                            <i class="fas fa-check-circle"></i> Resposta correcta!
                        </div>
                        <div class="feedback-section">
                            <h3><i class="fas fa-star"></i> Punt fort detectat</h3>
                            <p>${this.getStrengthForQuestion(question, userAnswer)}</p>
                        </div>
                        <div class="feedback-section">
                            <h3><i class="fas fa-rocket"></i> Per anar m√©s enll√†</h3>
                            <p>${this.getAdvancedSuggestion(question)}</p>
                        </div>
                    `;
                } else {
                    feedbackHTML += `
                        <div class="feedback-message feedback-incorrect">
                            <i class="fas fa-times-circle"></i> Resposta incorrecta
                        </div>
                        <div class="feedback-section">
                            <h3><i class="fas fa-search"></i> Error detectat</h3>
                            <p>${this.getErrorAnalysis(question, userAnswer)}</p>
                        </div>
                        <div class="feedback-section">
                            <h3><i class="fas fa-wrench"></i> Correcci√≥</h3>
                            <p>${this.getCorrection(question, correctAnswer)}</p>
                        </div>
                        <div class="feedback-section">
                            <h3><i class="fas fa-lightbulb"></i> Consell pr√†ctic</h3>
                            <p>${this.getPracticalTip(question)}</p>
                        </div>
                    `;
                }
                
                return feedbackHTML;
            },
            
            // Feedback per a preguntes de desenvolupament
            generateDevelopmentFeedback: function(answer, question) {
                const analysis = this.analyzeDevelopmentAnswer(answer, question);
                let feedbackHTML = '';
                
                feedbackHTML += `
                    <div class="feedback-section">
                        <h3><i class="fas fa-chart-bar"></i> Avaluaci√≥ general</h3>
                        <p><strong>Qualificaci√≥:</strong> ${analysis.grade}/5 - ${analysis.gradeText}</p>
                        <p>${analysis.overallFeedback}</p>
                    </div>
                `;
                
                if (analysis.strengths.length > 0) {
                    feedbackHTML += `
                        <div class="feedback-section">
                            <h3><i class="fas fa-check-circle" style="color: #28a745;"></i> Punts forts</h3>
                            <ul class="strengths-list">
                                ${analysis.strengths.map(strength => `<li>${strength}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                if (analysis.improvements.length > 0) {
                    feedbackHTML += `
                        <div class="feedback-section">
                            <h3><i class="fas fa-sync-alt" style="color: #ffc107;"></i> √Ärees de millora</h3>
                            <ul class="improvements-list">
                                ${analysis.improvements.map(improvement => `<li>${improvement}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                feedbackHTML += `
                    <div class="concept-analysis">
                        <div class="concepts-included">
                            <h4><i class="fas fa-check" style="color: #28a745;"></i> Conceptes inclosos</h4>
                            <div class="concept-list">
                                ${analysis.concepts.included.map(concept => `<span class="concept-tag included">${concept}</span>`).join('')}
                            </div>
                        </div>
                        <div class="concepts-missing">
                            <h4><i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i> Conceptes a afegir</h4>
                            <div class="concept-list">
                                ${analysis.concepts.missing.map(concept => `<span class="concept-tag missing">${concept}</span>`).join('')}
                            </div>
                        </div>
                    </div>
                `;
                
                if (analysis.suggestions.length > 0) {
                    feedbackHTML += `
                        <div class="feedback-section">
                            <h3><i class="fas fa-lightbulb" style="color: #4a6fa5;"></i> Suggeriments</h3>
                            <ul class="suggestions-list">
                                ${analysis.suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                            </ul>
                        </div>
                    `;
                }
                
                return feedbackHTML;
            },
            
            // An√†lisi de respostes de desenvolupament
            analyzeDevelopmentAnswer: function(answer, question) {
                const answerLower = answer.toLowerCase();
                let score = 0;
                const strengths = [];
                const improvements = [];
                const suggestions = [];
                
                // Conceptes clau per a cada pregunta
                const keyConcepts = this.getKeyConceptsForQuestion(question.id);
                const includedConcepts = [];
                const missingConcepts = [];
                
                // Detectar conceptes inclosos i faltants
                keyConcepts.forEach(concept => {
                    if (answerLower.includes(concept.toLowerCase())) {
                        includedConcepts.push(concept);
                        score += 1;
                    } else {
                        missingConcepts.push(concept);
                    }
                });
                
                // An√†lisi de longitud
                if (answer.length > 100) {
                    score += 1;
                    strengths.push("La longitud de la resposta √©s adequada");
                } else {
                    improvements.push("La resposta √©s massa curta; intenta desenvolupar m√©s les teves idees");
                }
                
                // An√†lisi d'estructura
                if (answer.split(/[.!?]+/).length > 3) {
                    score += 1;
                    strengths.push("Has estructurat la resposta en diverses frases");
                }
                
                if (/(a m√©s|tamb√©|perqu√®|a causa de|per tant)/i.test(answer)) {
                    score += 1;
                    strengths.push("Utilitzes connectors per relacionar les teves idees");
                }
                
                // An√†lisi de profunditat
                if (/(va provocar|com a resultat|a conseq√º√®ncia|degut a)/i.test(answer)) {
                    score += 1;
                    strengths.push("Expliques relacions de causa-efecte");
                } else {
                    improvements.push("Prova a explicar m√©s les causes i conseq√º√®ncies dels fets");
                }
                
                // Suggeriments espec√≠fics
                if (includedConcepts.length < keyConcepts.length / 2) {
                    suggestions.push("Investiga m√©s sobre: " + missingConcepts.slice(0, 3).join(", "));
                }
                
                if (answer.length < 150) {
                    suggestions.push("Amplia la teva resposta afegint m√©s detalls i exemples");
                }
                
                // Determinar qualificaci√≥
                let grade, gradeText, overallFeedback;
                if (score >= 7) {
                    grade = 5;
                    gradeText = "Excel¬∑lent";
                    overallFeedback = "Has fet una an√†lisi completa i ben estructurada del tema.";
                } else if (score >= 5) {
                    grade = 4;
                    gradeText = "Notable";
                    overallFeedback = "Bona resposta que cobreix els aspectes principals del tema.";
                } else if (score >= 3) {
                    grade = 3;
                    gradeText = "B√©";
                    overallFeedback = "Resposta correcta per√≤ es podria aprofundir m√©s en alguns aspectes.";
                } else if (score >= 2) {
                    grade = 2;
                    gradeText = "Suficient";
                    overallFeedback = "Has incl√≤s alguns elements clau per√≤ cal desenvolupar m√©s la resposta.";
                } else {
                    grade = 1;
                    gradeText = "A millorar";
                    overallFeedback = "La resposta √©s massa b√†sica; cal incloure m√©s contingut i estructura.";
                }
                
                return {
                    grade,
                    gradeText,
                    overallFeedback,
                    strengths,
                    improvements,
                    suggestions,
                    concepts: {
                        included: includedConcepts,
                        missing: missingConcepts
                    }
                };
            },
            
            // Funcions auxiliars
            getKeyConceptsForQuestion: function(questionId) {
                const conceptMap = {
                    "SA1-P3": ["invasions germ√†niques", "visigots", "vandals", "francs", "huns", "pressi√≥ militar", "p√®rdua territoris", "fragilitat pol√≠tica"],
                    "SA2-P3": ["pont cultural", "preservaci√≥ saber", "dret rom√†", "transmissi√≥ cultural", "defensa Europa", "her√®ncia grecoromana"],
                    "SA3-P3": ["expansi√≥ r√†pida", "unificaci√≥ √†rab", "toler√†ncia religiosa", "incentius econ√≤mics", "estrat√®gia militar", "debilitat imperis ve√Øns"],
                    "SA4-P3": ["renaixement carolingi", "reforma educativa", "preservaci√≥ textos", "min√∫scula carol√≠ngia", "arquitectura", "reforma religiosa"]
                };
                
                return conceptMap[questionId] || ["concepte 1", "concepte 2", "concepte 3"];
            },
            
            getStrengthForQuestion: function(question, userAnswer) {
                const strengthMap = {
                    "SA1-P1": "Has identificat correctament que la inestabilitat pol√≠tica era un factor clau en la crisi de l'Imperi Rom√†.",
                    "SA1-P2": "Has ent√®s correctament que la divisi√≥ de l'imperi va afeblir l'Occident.",
                    "SA2-P1": "Has recordat correctament que Constantinoble era la capital de l'Imperi Bizant√≠.",
                    "SA2-P2": "Has identificat correctament que el grec va substituir el llat√≠ com a llengua principal.",
                    "SA3-P1": "Has encertat el lloc de naixement de Mahoma, fonamental per entendre els or√≠gens de l'islam.",
                    "SA3-P2": "Has ent√®s que l'expansi√≥ isl√†mica va ser un proc√©s complex que inclo√Øa aspectes culturals i comercials.",
                    "SA4-P1": "Has recordat correctament que el papa Lle√≥ III va coronar Carlemany.",
                    "SA4-P2": "Has identificat correctament que l'Imperi Carolingi es va fragmentar poc despr√©s de la mort de Carlemany."
                };
                
                return strengthMap[question.id] || "Has demostrat comprensi√≥ del concepte clau.";
            },
            
            getErrorAnalysis: function(question, userAnswer) {
                const errorMap = {
                    "SA1-P1": "Has conf√≥s una causa econ√≤mica (p√®rdua de terres) amb una causa pol√≠tica.",
                    "SA1-P2": "No has considerat que la divisi√≥ va afeblir l'Occident en beneficiar l'Orient.",
                    "SA2-P1": "Has conf√≥s la capital de l'Imperi Bizant√≠ amb una altra ciutat important.",
                    "SA2-P2": "Has sobreestimat la perman√®ncia del llat√≠ com a llengua oficial.",
                    "SA3-P1": "Has conf√≥s el lloc de naixement de Mahoma amb una altra ciutat important en l'expansi√≥ isl√†mica.",
                    "SA3-P2": "Has subestimat la complexitat de l'expansi√≥ isl√†mica, centrant-te nom√©s en l'aspecte militar.",
                    "SA4-P1": "Has conf√≥s el papa que va coronar Carlemany amb un altre papa important.",
                    "SA4-P2": "Has sobreestimat la durada de l'Imperi Carolingi despr√©s de la mort de Carlemany."
                };
                
                return errorMap[question.id] || "Has com√®s un error en la comprensi√≥ del concepte.";
            },
            
            getCorrection: function(question, correctAnswer) {
                if (question.type === "multiple-choice") {
                    return `La resposta correcta √©s: "${question.options[correctAnswer]}"`;
                } else if (question.type === "true-false") {
                    return correctAnswer ? 
                        "La resposta correcta √©s Vertader. " + question.modelAnswer.split("</strong>")[1] :
                        "La resposta correcta √©s Fals. " + question.modelAnswer.split("</strong>")[1];
                }
                return "Revisa el model de resposta per entendre la correcci√≥.";
            },
            
            getPracticalTip: function(question) {
                const tipMap = {
                    "SA1-P1": "Per diferenciar causes pol√≠tiques, pregunta't: Aquest factor afecta el govern o l'administraci√≥?",
                    "SA1-P2": "Recorda que la divisi√≥ va beneficiar l'Orient (m√©s ric) i va perjudicar l'Occident.",
                    "SA2-P1": "Constantinoble va ser la capital de l'Imperi Rom√† d'Orient durant m√©s de 1000 anys.",
                    "SA2-P2": "El grec va esdevenir la llengua de la cultura i l'administraci√≥ a Bizanci.",
                    "SA3-P1": "La Meca √©s el lloc de naixement de Mahoma i la ciutat m√©s sagrada de l'islam.",
                    "SA3-P2": "L'expansi√≥ isl√†mica va combinar conquesta militar amb difusi√≥ cultural i comercial.",
                    "SA4-P1": "El papa Lle√≥ III va coronar Carlemany el 800, restablint la dignitat imperial a Occident.",
                    "SA4-P2": "L'Imperi Carolingi es va dividir entre els nets de Carlemany al Tractat de Verdun (843)."
                };
                
                return tipMap[question.id] || "Revisa els conceptes b√†sics i intenta-ho de nou.";
            },
            
            getAdvancedSuggestion: function(question) {
                const suggestionMap = {
                    "SA1-P1": "Ara podries investigar com aquesta inestabilitat pol√≠tica afectava l'economia i la defensa de l'imperi.",
                    "SA1-P2": "Investiga com la divisi√≥ va influir en el desenvolupament cultural diferent d'Orient i Occident.",
                    "SA2-P1": "Investiga per qu√® Constant√≠ va triar aquesta ubicaci√≥ per a la nova capital.",
                    "SA2-P2": "Estudia com el canvi ling√º√≠stic reflecteix la transformaci√≥ cultural de l'imperi.",
                    "SA3-P1": "Investiga la import√†ncia de La Meca com a centre de pelegrinatge en l'islam.",
                    "SA3-P2": "Estudia els mecanismes de difusi√≥ cultural de l'islam m√©s enll√† de la conquesta militar.",
                    "SA4-P1": "Investiga les motivacions del papa Lle√≥ III per coronar Carlemany.",
                    "SA4-P2": "Estudia com la divisi√≥ de l'imperi va influir en la formaci√≥ dels estats europeus medievals."
                };
                
                return suggestionMap[question.id] || "Continua aprofundint en aquest tema per consolidar el teu aprenentatge.";
            }
        };
        
        function setupEventListeners() {
            // Bot√≥ per enviar resposta
            submitBtn.addEventListener('click', function() {
                const situation = situations[currentSituationIndex];
                const question = situation.questions[currentQuestionIndex];
                let validAnswer = false;
                
                // Validar que s'hagi donat una resposta
                if (question.type === 'multiple-choice' || question.type === 'true-false') {
                    validAnswer = userAnswers[currentSituationIndex][currentQuestionIndex] !== null;
                } else if (question.type === 'development') {
                    validAnswer = userAnswers[currentSituationIndex][currentQuestionIndex] && 
                                 userAnswers[currentSituationIndex][currentQuestionIndex].trim() !== '';
                } else if (question.type === 'fill-blanks') {
                    validAnswer = userAnswers[currentSituationIndex][currentQuestionIndex] && 
                                 Object.keys(userAnswers[currentSituationIndex][currentQuestionIndex]).length > 0;
                }
                
                if (!validAnswer) {
                    alert('Si us plau, respon la pregunta abans d\'enviar.');
                    return;
                }
                
                // Marcar com a enviada
                answerSubmitted[currentSituationIndex][currentQuestionIndex] = true;
                
                // Generar feedback segons el tipus de pregunta
                let feedbackHTML = '';
                
                if (question.type === 'multiple-choice' || question.type === 'true-false') {
                    feedbackHTML = feedbackSystem.generateObjectiveFeedback(
                        userAnswers[currentSituationIndex][currentQuestionIndex],
                        question.correctAnswer,
                        question,
                        question.type
                    );
                    
                    // Desbloquejar ins√≠gnia si √©s correcte
                    if (userAnswers[currentSituationIndex][currentQuestionIndex] === question.correctAnswer) {
                        unlockedBadges[currentSituationIndex] = true;
                        updateBadges();
                    }
                } else if (question.type === 'development') {
                    feedbackHTML = feedbackSystem.generateDevelopmentFeedback(
                        userAnswers[currentSituationIndex][currentQuestionIndex],
                        question
                    );
                    
                    // Desbloquejar ins√≠gnia si la qualificaci√≥ √©s suficient o superior
                    const analysis = feedbackSystem.analyzeDevelopmentAnswer(
                        userAnswers[currentSituationIndex][currentQuestionIndex],
                        question
                    );
                    if (analysis.grade >= 3) {
                        unlockedBadges[currentSituationIndex] = true;
                        updateBadges();
                    }
                } else if (question.type === 'fill-blanks') {
                    // Per a preguntes d'emplenar buits, fem una avaluaci√≥ simple
                    let correctCount = 0;
                    question.blanks.forEach(blank => {
                        const input = document.getElementById(blank.id);
                        if (input && input.value.toLowerCase() === blank.answer.toLowerCase()) {
                            correctCount++;
                        }
                    });
                    
                    const percentage = (correctCount / question.blanks.length) * 100;
                    const isGood = percentage >= 60;
                    
                    if (isGood) {
                        unlockedBadges[currentSituationIndex] = true;
                        updateBadges();
                    }
                    
                    feedbackHTML = `
                        <div class="feedback-message ${isGood ? 'feedback-correct' : 'feedback-incorrect'}">
                            <i class="fas fa-${isGood ? 'check' : 'times'}-circle"></i> 
                            ${isGood ? 'Bona feina!' : 'Has de revisar alguns conceptes'}
                        </div>
                        <div class="feedback-section">
                            <h3><i class="fas fa-chart-bar"></i> Resultat</h3>
                            <p>Has encertat <strong>${correctCount} de ${question.blanks.length}</strong> buits (${percentage}%)</p>
                        </div>
                        <div class="feedback-section">
                            <h3><i class="fas fa-lightbulb"></i> Recomanaci√≥</h3>
                            <p>${isGood ? 
                                'Continua practicant per millorar encara m√©s' : 
                                'Revisa el model de resposta i torna a intentar-ho'}</p>
                        </div>
                    `;
                }
                
                // Mostrar el feedback
                feedbackContentEl.innerHTML = feedbackHTML;
                feedbackContainerEl.style.display = 'block';
                
                // Actualitzar la pregunta per mostrar el resultat
                loadQuestion(currentSituationIndex, currentQuestionIndex);
            });
            
            // Botons de navegaci√≥
            nextBtn.addEventListener('click', function() {
                if (currentQuestionIndex < situations[currentSituationIndex].questions.length - 1) {
                    currentQuestionIndex++;
                    loadQuestion(currentSituationIndex, currentQuestionIndex);
                }
            });
            
            prevBtn.addEventListener('click', function() {
                if (currentQuestionIndex > 0) {
                    currentQuestionIndex--;
                    loadQuestion(currentSituationIndex, currentQuestionIndex);
                }
            });
            
            // Bot√≥ per tornar a l'inici
            homeBtn.addEventListener('click', function() {
                showScreen(welcomeScreen);
            });
            
            // Bot√≥ per mostrar/amagar el model de resposta
            toggleModelBtn.addEventListener('click', function() {
                if (modelAnswerEl.style.display === 'none') {
                    modelAnswerEl.style.display = 'block';
                    toggleModelBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Amaga model de resposta';
                } else {
                    modelAnswerEl.style.display = 'none';
                    toggleModelBtn.innerHTML = '<i class="fas fa-eye"></i> Mostra model de resposta';
                }
            });
            
            // Botons d'accessibilitat
            contrastBtn.addEventListener('click', function() {
                document.body.classList.toggle('high-contrast');
            });
            
            textSizeBtn.addEventListener('click', function() {
                document.body.classList.toggle('large-text');
            });
            
            // Targetes de situacions d'aprenentatge
            situationCards.forEach(card => {
                card.addEventListener('click', function() {
                    const situationIndex = parseInt(this.getAttribute('data-situation'));
                    currentSituationIndex = situationIndex;
                    currentQuestionIndex = 0;
                    loadQuestion(currentSituationIndex, currentQuestionIndex);
                    showScreen(questionScreen);
                });
            });
        }
        
        function updateBadges() {
            badgeElements.forEach((badge, index) => {
                if (unlockedBadges[index]) {
                    badge.classList.remove('locked');
                    badge.classList.add('unlocked');
                    badge.title = situations[index].badge.name + " - Desbloquejada!";
                } else {
                    badge.classList.remove('unlocked');
                    badge.classList.add('locked');
                    badge.title = situations[index].badge.name + " - Bloquejada";
                }
            });
        }
    </script>
</body>
</html>